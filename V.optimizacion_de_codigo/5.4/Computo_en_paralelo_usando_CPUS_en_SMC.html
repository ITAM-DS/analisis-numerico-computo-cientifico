
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>5.4 Cómputo en paralelo usando CPUs en un sistema de memoria compartida (SMC)</title>
    
  <link rel="stylesheet" href="../../_static/css/index.73d71520a4ca3b99cfee5594769eaaae.css">

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      
  <link rel="stylesheet"
    href="../../_static/vendor/open-sans_all/1.44.1/index.css">
  <link rel="stylesheet"
    href="../../_static/vendor/lato_latin-ext/1.44.1/index.css">

    
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/sphinx-book-theme.40e2e510f6b7d1648584402491bb10fe.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../../_static/js/index.3da636dd464baa7582d2.js">

    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/togglebutton.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../_static/sphinx-book-theme.d31b09fe5c1d09cb49b26a786de4a05d.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe,.cell"
        const thebe_selector_input = "pre,.cell_input div.highlight"
        const thebe_selector_output = ".output,.cell_output"
    </script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="5.5 Cómputo en paralelo usando GPUs en un sistema de memoria compartida (SMC)" href="../5.5/Computo_en_paralelo_usando_GPUS_en_SMC.html" />
    <link rel="prev" title="5.3 Compilación a C" href="../5.3/Compilacion_a_C.html" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />



  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="../../index.html">
  
  <img src="../../_static/logo.png" class="logo" alt="logo">
  
  
</a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form>
<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../../README.html">
   Optimización
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  I. Cómputo científico
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../../I.computo_cientifico/1.1/Analisis_numerico_y_computo_cientifico.html">
   1.1 Análisis numérico y cómputo científico
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../I.computo_cientifico/1.2/Sistema_de_punto_flotante.html">
   1.2 Sistema de punto flotante
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../I.computo_cientifico/1.3/Normas_vectoriales_y_matriciales.html">
   1.3 Normas vectoriales y matriciales
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../I.computo_cientifico/1.4/Condicion_de_un_problema_y_estabilidad_de_un_algoritmo.html">
   1.4 Condición de un problema y estabilidad de un algoritmo
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../I.computo_cientifico/1.5/Definicion_de_funcion_continuidad_derivada.html">
   1.5 Definición de función, continuidad y derivada
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../I.computo_cientifico/1.6/Polinomios_de_Taylor_y_diferenciacion_numerica.html">
   1.6 Polinomios de Taylor y diferenciación numérica
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../I.computo_cientifico/1.7/Integracion_numerica.html">
   1.7 Integración Numérica
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  II. Cómputo matricial
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../../II.computo_matricial/2.1/Operaciones_y_transformaciones_basicas_del_Algebra_Lineal_Numerica.html">
   2.1 Operaciones y transformaciones básicas del Álgebra Lineal Numérica
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../II.computo_matricial/2.2/Eigenvalores_y_eigenvectores.html">
   2.2 Eigenvalores y eigenvectores
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../II.computo_matricial/2.3/Algoritmos_y_aplicaciones_de_eigenvalores_eigenvectores_de_una_matriz.html">
   2.3 Algoritmos y aplicaciones de eigenvalores y eigenvectores de una matriz
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../II.computo_matricial/2.4/Valores_vectores_singulares_y_algoritmos_para_calcular_la_SVD.html">
   2.4 Valores, vectores singulares y algoritmos para calcular la SVD
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  III. Optimización convexa y ecuaciones no lineales
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../../III.optimizacion_convexa/3.1/Definicion_de_problema_optimizacion_conjuntos_y_funciones_convexas.html">
   3.1 Definición de problemas de optimización, conjuntos y funciones convexas
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../III.optimizacion_convexa/3.2/Algoritmos_de_descenso_y_busqueda_de_linea_en_uco.html">
   3.2 Algoritmos de descenso y búsqueda de línea en
   <em>
    Unconstrained Convex Optimization
   </em>
   (UCO)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../III.optimizacion_convexa/3.3/Ejemplos_problemas_UCO_e_intro_CIEO_y_PI.html">
   3.3 Ejemplos de problemas UCO, introducción a
   <em>
    Constrained Inequality and Equality Optimization
   </em>
   (CIEO) y puntos interiores
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../III.optimizacion_convexa/3.4/Ecuaciones_no_lineales.html">
   3.4 Ecuaciones no lineales
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  IV. Optimización en redes y programación lineal
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../../IV.optimizacion_en_redes_y_prog_lineal/4.1/Definiciones_generales_de_flujo_en_redes.html">
   4.1 Definiciones generales de flujo en redes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../IV.optimizacion_en_redes_y_prog_lineal/4.2/Programacion_lineal_y_metodo_simplex.html">
   4.2 Programación lineal (PL) y método símplex
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../IV.optimizacion_en_redes_y_prog_lineal/4.3/Ejemplo_metodo_simplex_de_redes.html">
   4.3 Ejemplo del método símplex de redes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../IV.optimizacion_en_redes_y_prog_lineal/4.4/Dualidad_lema_de_Farkas_condiciones_KKT_de_optimalidad.html">
   4.4 Dualidad, lema de Farkas y condiciones de Karush-Kuhn-Tucker (KKT) de optimalidad
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../IV.optimizacion_en_redes_y_prog_lineal/4.5/Metodo_primal_dual_de_BL.html">
   4.5 Método primal-dual de barrera logarítmica (BL)
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  V. Optimización de código
 </span>
</p>
<ul class="current nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../5.1/introduccion_optimizacion_de_codigo.html">
   5.1 Introducción a optimización de código
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../5.2/Herramientas_de_lenguajes_y_del_SO_para_perfilamiento_e_implementaciones_de_BLAS.html">
   5.2 Herramientas de lenguajes de programación y del sistema operativo para perfilamiento e implementaciones de BLAS
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../5.3/Compilacion_a_C.html">
   5.3 Compilación a C
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   5.4 Cómputo en paralelo usando CPUs en un sistema de memoria compartida (SMC)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../5.5/Computo_en_paralelo_usando_GPUS_en_SMC.html">
   5.5 Cómputo en paralelo usando GPUs en un sistema de memoria compartida (SMC)
  </a>
 </li>
</ul>
<p class="caption collapsible-parent">
 <span class="caption-text">
  VI. Algoritmos de optimización convexa
 </span>
</p>
<ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="../../VI.algoritmos_optimizacion_convexa/6.1/Problemas_UCO.html">
   6.1 Problemas tipo
   <em>
    Unconstrained Convex Optimization
   </em>
   (UCO)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../VI.algoritmos_optimizacion_convexa/6.2/Problemas_CECO.html">
   6.2 Problemas tipo
   <em>
    Constrained Equality Convex Optimization
   </em>
   (CECO)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../VI.algoritmos_optimizacion_convexa/6.3/Problemas_CIECO.html">
   6.3 Problemas tipo
   <em>
    Constrained Equality and Inequality Convex Optimization
   </em>
   (CIECO)
  </a>
 </li>
</ul>

</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="row topbar fixed-top container-xl">
    <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show">
    </div>
    <div class="col pl-2 topbar-main">
        
        <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
            data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
            aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
            title="Toggle navigation" data-toggle="tooltip" data-placement="left">
            <i class="fas fa-bars"></i>
            <i class="fas fa-arrow-left"></i>
            <i class="fas fa-arrow-up"></i>
        </button>
        
        
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../../_sources/V.optimizacion_de_codigo/5.4/Computo_en_paralelo_usando_CPUS_en_SMC.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

        <!-- Source interaction buttons -->


        <!-- Full screen (wrap in <a> to have style consistency -->
        <a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
                data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
                title="Fullscreen mode"><i
                    class="fas fa-expand"></i></button></a>

        <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/palmoreck/dockerfiles-for-binder/jupyterlab_optimizacion_2?urlpath=lab/tree/analisis-numerico-computo-cientifico/libro_optimizacion/temas/V.optimizacion_de_codigo/5.4/Computo_en_paralelo_usando_CPUS_en_SMC.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        <button type="button" class="btn btn-secondary topbarbtn"
            onclick="initThebeSBT()" title="Launch Thebe" data-toggle="tooltip" data-placement="left"><i
                class="fas fa-play"></i><span style="margin-left: .4em;">Live Code</span></button>
        
    </div>
</div>

    </div>

    <!-- Table of contents -->
    <div class="d-none d-md-block col-md-2 bd-toc show">
        
        <div class="tocsection onthispage pt-5 pb-3">
            <i class="fas fa-list"></i> Contents
        </div>
        <nav id="bd-toc-nav">
            <ul class="nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#sistemas-de-memoria-compartida-smc">
   Sistemas de memoria compartida (SMC)
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#openmp">
   OpenMP
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#directiva-parallel">
     Directiva parallel
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#ejemplo">
     Ejemplo
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#num-threads-clause">
     <code class="docutils literal notranslate">
      <span class="pre">
       num_threads
      </span>
     </code>
     <em>
      clause
     </em>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id1">
     Ejemplo
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#reduction-clause">
     <em>
      Reduction clause
     </em>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id2">
     Ejemplo
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#ejemplo-regla-compuesta-del-rectangulo">
     Ejemplo regla compuesta del rectángulo
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#directiva-parallel-for">
     Directiva
     <em>
      parallel for
     </em>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#ejemplo-regla-compuesta-del-rectangulo-con-directiva-parallel-for">
     Ejemplo regla compuesta del rectángulo con directiva
     <em>
      parallel for
     </em>
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#multiprocessing">
   Multiprocessing
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#nota-sobre-el-gil-y-multiprocessing">
     Nota sobre el GIL y
     <em>
      multiprocessing
     </em>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id3">
     Ejemplo
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#pool-of-workers">
     <em>
      Pool of workers
     </em>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id4">
     Ejemplo
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#ejemplo-utilizando-apply">
     Ejemplo utilizando
     <code class="docutils literal notranslate">
      <span class="pre">
       apply
      </span>
     </code>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#ejemplo-con-context-manager">
     Ejemplo con context manager
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#ejemplo-para-pasar-multiples-argumentos-via-starmap">
     Ejemplo para pasar múltiples argumentos vía starmap
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id5">
     Ejemplo regla compuesta del rectángulo
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#dask">
   Dask
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#como-se-implementan-una-task-y-una-task-dask-graph-en-dask">
     ¿Cómo se implementan una
     <em>
      task
     </em>
     y una
     <em>
      task/dask graph
     </em>
     en
     <em>
      Dask
     </em>
     ?
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#como-ejecutamos-la-task-dask-graph">
     ¿Cómo ejecutamos la
     <em>
      task/dask graph
     </em>
     ?
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#como-visualizamos-la-task-dask-graph">
     ¿Cómo visualizamos la
     <em>
      task/dask graph
     </em>
     ?
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#flujo-de-trabajo-con-dask-collections">
     Flujo de trabajo con
     <em>
      Dask collections
     </em>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id6">
     Ejemplo
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#dask-distributed">
     Dask distributed
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#concurrent-futures">
     ¿concurrent.futures?
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id7">
     Ejemplo
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#client-de-dask-distributed">
     <em>
      Client
     </em>
     de
     <code class="docutils literal notranslate">
      <span class="pre">
       dask.distributed
      </span>
     </code>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#ejemplo-regla-compuesta-del-rectangulo-con-map-y-gather">
     Ejemplo regla compuesta del rectángulo con
     <code class="docutils literal notranslate">
      <span class="pre">
       map
      </span>
     </code>
     y
     <code class="docutils literal notranslate">
      <span class="pre">
       gather
      </span>
     </code>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#ejemplo-regla-compuesta-del-rectangulo-con-map-y-result">
     Ejemplo regla compuesta del rectángulo con
     <code class="docutils literal notranslate">
      <span class="pre">
       map
      </span>
     </code>
     y
     <code class="docutils literal notranslate">
      <span class="pre">
       result
      </span>
     </code>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#grafica-de-tiempo-de-ejecucion-vs-numero-de-procesos">
     Gráfica de tiempo de ejecución vs número de procesos
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#ejemplo-regla-compuesta-del-rectangulo-con-dask-array">
     Ejemplo regla compuesta del rectángulo con
     <code class="docutils literal notranslate">
      <span class="pre">
       dask.array
      </span>
     </code>
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#parallel">
   Parallel
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id8">
     Ejemplo
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#clusterapply">
       clusterApply
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#ejemplo-de-pasar-argumentos-via-clusterexport">
     Ejemplo de pasar argumentos vía
     <code class="docutils literal notranslate">
      <span class="pre">
       clusterExport
      </span>
     </code>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#ejemplo-regla-compuesta-del-rectangulo-con-clusterapply">
     Ejemplo regla compuesta del rectángulo con
     <code class="docutils literal notranslate">
      <span class="pre">
       clusterApply
      </span>
     </code>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#ejemplo-regla-compuesta-del-rectangulo-con-clustersplit">
     Ejemplo regla compuesta del rectángulo con
     <code class="docutils literal notranslate">
      <span class="pre">
       clusterSplit
      </span>
     </code>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id9">
     Gráfica de tiempo de ejecución vs número de procesos
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#referencias-de-interes">
   Referencias de interés
  </a>
 </li>
</ul>

        </nav>
        
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="computo-en-paralelo-usando-cpus-en-un-sistema-de-memoria-compartida-smc">
<span id="compparalelocpussmc"></span><h1>5.4 Cómputo en paralelo usando CPUs en un sistema de memoria compartida (SMC)<a class="headerlink" href="#computo-en-paralelo-usando-cpus-en-un-sistema-de-memoria-compartida-smc" title="Permalink to this headline">¶</a></h1>
<div class="admonition-notas-para-contenedor-de-docker admonition">
<p class="admonition-title">Notas para contenedor de docker:</p>
<p>Comando de docker para ejecución de la nota de forma local:</p>
<p>nota: cambiar <code class="docutils literal notranslate"><span class="pre">&lt;ruta</span> <span class="pre">a</span> <span class="pre">mi</span> <span class="pre">directorio&gt;</span></code> por la ruta de directorio que se desea mapear a <code class="docutils literal notranslate"><span class="pre">/datos</span></code> dentro del contenedor de docker.</p>
<p><code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">run</span> <span class="pre">--rm</span> <span class="pre">-v</span> <span class="pre">&lt;ruta</span> <span class="pre">a</span> <span class="pre">mi</span> <span class="pre">directorio&gt;:/datos</span> <span class="pre">--name</span> <span class="pre">jupyterlab_optimizacion_2</span> <span class="pre">-p</span> <span class="pre">8888:8888</span> <span class="pre">-p</span> <span class="pre">8787:8787</span> <span class="pre">-d</span> <span class="pre">palmoreck/jupyterlab_optimizacion_2:3.0.0</span></code></p>
<p>password para jupyterlab: <code class="docutils literal notranslate"><span class="pre">qwerty</span></code></p>
<p>Detener el contenedor de docker:</p>
<p><code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">stop</span> <span class="pre">jupyterlab_optimizacion_2</span></code></p>
<p>Documentación de la imagen de docker <code class="docutils literal notranslate"><span class="pre">palmoreck/jupyterlab_optimizacion_2:3.0.0</span></code> en <a class="reference external" href="https://github.com/palmoreck/dockerfiles/tree/master/jupyterlab/optimizacion_2">liga</a>.</p>
</div>
<hr class="docutils" />
<p>Nota generada a partir de <a class="reference external" href="https://www.dropbox.com/s/oauifmx3e19ofyq/2.3.Sistemas_de_memoria_compartida_Pthreads.pdf?dl=0">liga1</a>, <a class="reference external" href="https://www.dropbox.com/s/vcxbrqkk6x946d7/2.4.Sistemas_de_memoria_compartida_openMP.pdf?dl=0">liga2</a>, <a class="reference external" href="https://www.dropbox.com/s/v4ub0p3ndf7w1p0/2.2.Sistemas_de_memoria_distribuida_MPI.pdf?dl=0">liga3</a></p>
<div class="tip admonition">
<p class="admonition-title">Al final de esta nota el y la lectora:</p>
<ul class="simple">
<li></li>
</ul>
</div>
<p>Se presentan códigos y sus ejecuciones en una máquina <code class="docutils literal notranslate"><span class="pre">m4.16xlarge</span></code> de la nube de <a class="reference external" href="https://aws.amazon.com/">AWS</a>. Se utilizó la AMI <code class="docutils literal notranslate"><span class="pre">opt2-aws-educate-openblas-02-05-2021</span></code> de la región <code class="docutils literal notranslate"><span class="pre">us-east-1</span></code> (Virginia) para reproducibilidad de resultados. Tal AMI se construyó a partir de una AMI <code class="docutils literal notranslate"><span class="pre">ubuntu</span> <span class="pre">20.04</span> <span class="pre">-</span> <span class="pre">ami-042e8287309f5df03</span></code> con el <a class="reference external" href="https://github.com/palmoreck/scripts_for_useful_tools_installations/blob/main/AWS/ubuntu_20.04/optimizacion_2/script_profiling_and_BLAS.sh">script_profiling_and_BLAS.sh</a></p>
<div class="admonition-comentario admonition">
<p class="admonition-title">Comentario</p>
<p>Si se utiliza la <em>AMI</em> <code class="docutils literal notranslate"><span class="pre">opt2-aws-educate-openblas-04-04-2021</span></code> colocar en <code class="docutils literal notranslate"><span class="pre">User</span> <span class="pre">data</span></code> el siguiente <em>script</em>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1">##variables:</span>
<span class="nv">region</span><span class="o">=</span>us-east-1 <span class="c1">#make sure instance is in Virginia</span>
<span class="nv">name_instance</span><span class="o">=</span>OpenBLAS
<span class="nv">USER</span><span class="o">=</span>ubuntu
<span class="c1">##System update</span>
apt-get update -yq
<span class="c1">##Tag instance</span>
<span class="nv">INSTANCE_ID</span><span class="o">=</span><span class="k">$(</span>curl -s http://instance-data/latest/meta-data/instance-id<span class="k">)</span>
<span class="nv">PUBLIC_IP</span><span class="o">=</span><span class="k">$(</span>curl -s http://instance-data/latest/meta-data/public-ipv4<span class="k">)</span>
sudo -H -u <span class="nv">$USER</span> bash -c <span class="s2">&quot;/home/</span><span class="nv">$USER</span><span class="s2">/.local/bin/aws ec2 create-tags --resources </span><span class="nv">$INSTANCE_ID</span><span class="s2"> --tag Key=Name,Value=</span><span class="nv">$name_instance</span><span class="s2">-</span><span class="nv">$PUBLIC_IP</span><span class="s2"> --region=</span><span class="nv">$region</span><span class="s2">&quot;</span>
sudo -H -u <span class="nv">$USER</span> bash -c <span class="s2">&quot;cd / &amp;&amp; /home/</span><span class="nv">$USER</span><span class="s2">/.local/bin/jupyter lab --ip=0.0.0.0 --no-browser --config=/home/</span><span class="nv">$USER</span><span class="s2">/.jupyter/jupyter_notebook_config.py &amp;&quot;</span>
</pre></div>
</div>
</div>
<p>La máquina <code class="docutils literal notranslate"><span class="pre">m4.16xlarge</span></code> tiene las siguientes características:</p>
<div class="cell tag_output_scroll docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">bash</span>
lscpu
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Architecture:                    x86_64
CPU op-mode(s):                  32-bit, 64-bit
Byte Order:                      Little Endian
Address sizes:                   46 bits physical, 48 bits virtual
CPU(s):                          64
On-line CPU(s) list:             0-63
Thread(s) per core:              2
Core(s) per socket:              16
Socket(s):                       2
NUMA node(s):                    2
Vendor ID:                       GenuineIntel
CPU family:                      6
Model:                           79
Model name:                      Intel(R) Xeon(R) CPU E5-2686 v4 @ 2.30GHz
Stepping:                        1
CPU MHz:                         2213.083
CPU max MHz:                     3000.0000
CPU min MHz:                     1200.0000
BogoMIPS:                        4600.00
Hypervisor vendor:               Xen
Virtualization type:             full
L1d cache:                       1 MiB
L1i cache:                       1 MiB
L2 cache:                        8 MiB
L3 cache:                        90 MiB
NUMA node0 CPU(s):               0-15,32-47
NUMA node1 CPU(s):               16-31,48-63
Vulnerability Itlb multihit:     KVM: Vulnerable
Vulnerability L1tf:              Mitigation; PTE Inversion
Vulnerability Mds:               Vulnerable: Clear CPU buffers attempted, no microcode; SMT Host state unknown
Vulnerability Meltdown:          Mitigation; PTI
Vulnerability Spec store bypass: Vulnerable
Vulnerability Spectre v1:        Mitigation; usercopy/swapgs barriers and __user pointer sanitization
Vulnerability Spectre v2:        Mitigation; Full generic retpoline, STIBP disabled, RSB filling
Vulnerability Srbds:             Not affected
Vulnerability Tsx async abort:   Vulnerable: Clear CPU buffers attempted, no microcode; SMT Host state unknown
Flags:                           fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush mmx fxsr sse sse2 ht syscall nx pdpe1gb rdtscp lm constant_tsc arch_perfmon rep_good nopl xtopology nonstop_tsc cpuid aperfmperf pni pclmulqdq monitor est ssse3 fma cx16 pcid sse4_1 sse4_2 x2apic movbe popcnt tsc_deadline_timer aes xsave avx f16c rdrand hypervisor lahf_lm abm cpuid_fault invpcid_single pti fsgsbase bmi1 hle avx2 smep bmi2 erms invpcid rtm xsaveopt ida
</pre></div>
</div>
</div>
</div>
<div class="cell tag_output_scroll docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">bash</span>
sudo lshw -C memory
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  *-firmware
       description: BIOS
       vendor: Xen
       physical id: 0
       version: 4.11.amazon
       date: 08/24/2006
       size: 96KiB
       capabilities: pci edd
  *-memory
       description: System Memory
       physical id: 1000
       size: 256GiB
       capabilities: ecc
       configuration: errordetection=multi-bit-ecc
     *-bank:0
          description: DIMM RAM
          physical id: 0
          slot: DIMM 0
          size: 16GiB
          width: 64 bits
     *-bank:1
          description: DIMM RAM
          physical id: 1
          slot: DIMM 1
          size: 16GiB
          width: 64 bits
     *-bank:2
          description: DIMM RAM
          physical id: 2
          slot: DIMM 2
          size: 16GiB
          width: 64 bits
     *-bank:3
          description: DIMM RAM
          physical id: 3
          slot: DIMM 3
          size: 16GiB
          width: 64 bits
     *-bank:4
          description: DIMM RAM
          physical id: 4
          slot: DIMM 4
          size: 16GiB
          width: 64 bits
     *-bank:5
          description: DIMM RAM
          physical id: 5
          slot: DIMM 5
          size: 16GiB
          width: 64 bits
     *-bank:6
          description: DIMM RAM
          physical id: 6
          slot: DIMM 6
          size: 16GiB
          width: 64 bits
     *-bank:7
          description: DIMM RAM
          physical id: 7
          slot: DIMM 7
          size: 16GiB
          width: 64 bits
     *-bank:8
          description: DIMM RAM
          physical id: 8
          slot: DIMM 8
          size: 16GiB
          width: 64 bits
     *-bank:9
          description: DIMM RAM
          physical id: 9
          slot: DIMM 9
          size: 16GiB
          width: 64 bits
     *-bank:10
          description: DIMM RAM
          physical id: a
          slot: DIMM 10
          size: 16GiB
          width: 64 bits
     *-bank:11
          description: DIMM RAM
          physical id: b
          slot: DIMM 11
          size: 16GiB
          width: 64 bits
     *-bank:12
          description: DIMM RAM
          physical id: c
          slot: DIMM 12
          size: 16GiB
          width: 64 bits
     *-bank:13
          description: DIMM RAM
          physical id: d
          slot: DIMM 13
          size: 16GiB
          width: 64 bits
     *-bank:14
          description: DIMM RAM
          physical id: e
          slot: DIMM 14
          size: 16GiB
          width: 64 bits
     *-bank:15
          description: DIMM RAM
          physical id: f
          slot: DIMM 15
          size: 16GiB
          width: 64 bits
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">bash</span>
uname -ar #r for kernel, a for all
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Linux ip-10-0-0-84 5.4.0-1038-aws #40-Ubuntu SMP Fri Feb 5 23:50:40 UTC 2021 x86_64 x86_64 x86_64 GNU/Linux
</pre></div>
</div>
</div>
</div>
<div class="tip admonition">
<p class="admonition-title">Observación</p>
<p>En la celda anterior se utilizó el comando de <em>magic</em> <code class="docutils literal notranslate"><span class="pre">%%bash</span></code>. Algunos comandos de <em>magic</em> los podemos utilizar también con <code class="docutils literal notranslate"><span class="pre">import</span></code>. Ver <a class="reference external" href="https://ipython.readthedocs.io/en/stable/interactive/magics.html">ipython-magics</a></p>
</div>
<div class="section" id="sistemas-de-memoria-compartida-smc">
<h2>Sistemas de memoria compartida (SMC)<a class="headerlink" href="#sistemas-de-memoria-compartida-smc" title="Permalink to this headline">¶</a></h2>
<p>Un SMC en general se ve como el siguiente dibujo:</p>
<img src="https://dl.dropboxusercontent.com/s/ao3if8tzwsvzfi7/shared_memory_sistems.png?dl=0" heigth="500" width="500"><p>El dibujo anterior es un SMC con acceso uniforme a la memoria (<a class="reference external" href="https://en.wikipedia.org/wiki/Uniform_memory_access">UMA</a>), esto es, cada proceso o <em>thread</em> creado en el procesador o <em>core</em> accede con las mismas velocidades a la memoria.</p>
<p>La <strong>comunicación</strong> en este tipo de sistemas depende si se utilizan procesos o <em>threads</em> ya que aunque los procesos generados por un proceso principal tienen acceso a la memoria, los cambios/actualizaciones que haga uno de ellos a una variable no lo llegan a ver los otros procesos. Esto es distinto con los <em>threads</em> dado que un cambio que realice un <em>thread</em> en una variable sí lo pueden ver los otros <em>threads</em>. Lo anterior se debe a las distintas direcciones de memoria que utilizan los procesos vs la misma dirección de memoria que utilizan los <em>threads</em>.</p>
<p>Recuérdese que se crean <em>threads</em> a partir de un proceso principal, realizan <em>fork</em>, y una vez que terminan su ejecución se unen nuevamente, realizan <em>join</em>, esto es el <em>threading</em>.</p>
<img src="https://dl.dropboxusercontent.com/s/0vnjfdk7fo62m8h/threading.png?dl=0" heigth="400" width="400"><p>Ver <a class="reference internal" href="../5.1/introduccion_optimizacion_de_codigo.html#threadinghyper"><span class="std std-ref">Threading o Hyperthreading</span></a>.</p>
<div class="tip admonition">
<p class="admonition-title">Observación</p>
<p>Hay paqueterías que crean subprocesos a partir de un proceso principal en lugar de <em>threads</em>. En este caso en lugar de un <em>fork</em> se realiza un <em>spawn</em>. Los subprocesos pueden ver cambios a variables hechos por otros.</p>
<p>Ver <a class="reference external" href="https://docs.python.org/3.9/library/multiprocessing.html#contexts-and-start-methods">Contexts and start methods</a> y <a class="reference external" href="https://stackoverflow.com/questions/46045956/whats-the-difference-between-threadpool-vs-pool-in-python-multiprocessing-modul">difference between threadpool vs pool in python multiprocessing</a> para diferencias entre <em>fork</em> y <em>spawn</em>.</p>
</div>
<div class="admonition-definicion admonition">
<p class="admonition-title">Definición</p>
<p>Las variables que pueden ser accesadas por todos los <em>threads</em> en un SMC se les nombra <strong>variables compartidas</strong>.</p>
</div>
<p>Trabajar sobre SMC tiene ventajas y desventajas. Una ventaja es facilidad de comunicación y una desventaja es la <strong>coordinación</strong> para ejecutar instrucciones. Por ejemplo, con variables compartidas se puede realizar la comunicación entre los <em>threads</em>, sin embargo, para el uso de tales variables por diferentes <em>threads</em> debemos crear candados, <em>locks</em>. Lo anterior surge pues si un <em>thread</em> con etiqueta <span class="math notranslate nohighlight">\(1\)</span> accede a una variable compartida, otro <em>thread</em> con etiqueta <span class="math notranslate nohighlight">\(2\)</span>, no podrá utilizarla hasta que el thread <span class="math notranslate nohighlight">\(1\)</span> finalice de usarla. Ver <a class="reference external" href="https://en.wikipedia.org/wiki/Thread_safety">Thread Safety</a> y <a class="reference external" href="https://en.wikipedia.org/wiki/Race_condition#Computing">Race Condition</a>.</p>
<div class="admonition-definicion admonition">
<p class="admonition-title">Definición</p>
<p>En una <em>race condition</em> múltiples <em>threads</em> intentan acceder a un recurso compartido, al menos uno de los accesos resulta en una modificación al recurso y posteriormente los siguientes accesos pueden no ver la modificación. A la sección del código que causa la <em>race condition</em> se le nombra <em>critical section</em>. Las <em>critical sections</em> se ejecutan con código secuencial o con <em>locks</em> para evitar las <em>race conditions</em>.</p>
</div>
<div class="admonition-comentarios admonition">
<p class="admonition-title">Comentarios</p>
<ul class="simple">
<li><p>Para crear procesos o <em>threads</em> en los lenguajes de programación de <em>C, Python</em> o <em>R</em>, utilizamos las librerías, API’s o extensiones vía paquetes a tales lenguajes. Lo anterior se debe a que <em>C, Python</em> y <em>R</em> en sus implementaciones más utilizadas o estándar, fueron diseñados con el propósito de utilizarse sobre sistemas con un sólo procesador. En distintas implementaciones de los lenguajes hay soporte para SMC.</p></li>
<li><p>Ejemplos de máquinas con SMC son las laptops, los celulares, máquinas de escritorio con más de un <em>core</em>.</p></li>
<li><p>Otro tipo de SMC se puede representar con el siguiente dibujo:</p></li>
</ul>
<img src="https://dl.dropboxusercontent.com/s/dqwdqdxiecj91vy/shared_memory_systems_2.png?dl=0" heigth="500" width="500">
<p>en el que los procesos o <em>threads</em> pueden acceder a la memoria en una forma no uniforme <a class="reference external" href="https://en.wikipedia.org/wiki/Non-uniform_memory_access">(NUMA)</a>. Una de las diferencias que se tienen entre un NUMA y un UMA es la tasa de transferencia de datos para <em>cores</em> que están más cercanos a una memoria.</p>
<ul class="simple">
<li><p>Un sistema de memoria distribuida (SMD) tiene una conexión, por ejemplo vía una <em>network</em>, entre pares de <em>core-memoria</em> y en general se ve como el siguiente dibujo:</p></li>
</ul>
<img src="https://dl.dropboxusercontent.com/s/iky7af1m3dcj3e0/distributed_memory_systems.png?dl=0" heigth="600" width="600">
<p>La memoria en un SMD asociada al <em>core</em> sólo puede ser accesada por éste y es inaccesible a los demás <em>cores</em>, esto es, se tiene una memoria “privada”. Lo anterior contrasta con los SMC en los que todos los <em>cores</em> accesan a una memoria compartida. En un SMD el cómputo distribuido crea múltiples procesos a partir de un proceso principal. En un SMC el cómputo paralelo crea múltiples procesos o <em>threads</em>. Un ejemplo de un SMD es un clúster de máquinas. Cada máquina en el clúster puede ser un SMC y por tanto los procesos en cada máquina tienen la capacidad de crear procesos o <em>threads</em>. En este caso se tiene un sistema híbrido SMD y SMC. Un programa diseñado para ejecutarse en un SMD puede ejecutarse en un SMC pues se divide su memoria de forma lógica en espacios de memoria privados para los <em>threads</em>.</p>
</div>
</div>
<div class="section" id="openmp">
<h2><a class="reference external" href="http://www.openmp.org/">OpenMP</a><a class="headerlink" href="#openmp" title="Permalink to this headline">¶</a></h2>
<p>Es una extensión al lenguaje <em>C</em> y es una API para cómputo en paralelo en un sistema de memoria compartida, <em>aka, shared memory parallel programming</em> con CPUs. Lo anterior <em>OpenMP</em> lo posibilita con el <em>threading</em>.</p>
<ul class="simple">
<li><p>Las siglas <em>MP</em> se refieren a <em>multiprocessing</em>, un sinónimo de <em>shared memory parallel computing</em>. <em>OpenMP</em> se utiliza en un SMC por lo que cada <em>thread</em> tiene acceso a la memoria.</p></li>
<li><p>Algunas características de <em>OpenMP</em> son:</p>
<ul>
<li><p>Paralelización de ciclos <em>for</em> secuenciales en los que las iteraciones son independientes una de la otra de forma simple.</p></li>
<li><p>Paralelización de tareas y sincronización explícita de <em>threads</em>.</p></li>
</ul>
</li>
</ul>
<div class="margin sidebar">
<p class="sidebar-title"></p>
<p>Las directivas son instrucciones que indican al <a class="reference external" href="https://en.wikipedia.org/wiki/Preprocessor">preprocesador</a> (vía la compilación) que ejecutaremos una instrucción que no se encuentra en la especificación básica del lenguaje C. Ver <a class="reference external" href="https://en.wikipedia.org/wiki/C_preprocessor">C preprocessor</a>.</p>
</div>
<ul class="simple">
<li><p>Provee <strong>directivas</strong> vía <code class="docutils literal notranslate"><span class="pre">#pragma</span> <span class="pre">omp</span></code> para el cómputo en paralelo en un SMC.</p></li>
</ul>
<div class="admonition-comentario admonition">
<p class="admonition-title">Comentario</p>
<p>Los <code class="docutils literal notranslate"><span class="pre">pragma</span></code> se utilizan para extender la funcionalidad de <em>C</em> pues no son parte de su especificación básica. Las versiones más recientes del compilador <code class="docutils literal notranslate"><span class="pre">gcc</span></code> soportan a los <code class="docutils literal notranslate"><span class="pre">pragma</span></code> y todas las <em>preprocessor directives</em> son por <em>default</em> de longitud una línea.</p>
<p>Ver <a class="reference external" href="https://gcc.gnu.org/onlinedocs/cpp/Pragmas.html">pragmas</a>.</p>
</div>
<div class="section" id="directiva-parallel">
<h3>Directiva parallel<a class="headerlink" href="#directiva-parallel" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="ejemplo">
<h3>Ejemplo<a class="headerlink" href="#ejemplo" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">hello_world_omp.c</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%file</span> hello_world_omp.c
<span class="c1">#include&lt;stdio.h&gt;</span>
<span class="c1">#include&lt;stdlib.h&gt;</span>
<span class="c1">#include&lt;omp.h&gt; </span>

<span class="n">void</span> <span class="n">Hello</span><span class="p">(</span><span class="n">void</span><span class="p">);</span>
<span class="nb">int</span> <span class="n">main</span><span class="p">(){</span>

    <span class="c1">#pragma omp parallel</span>
        <span class="n">Hello</span><span class="p">();</span>
    
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">void</span> <span class="n">Hello</span><span class="p">(</span><span class="n">void</span><span class="p">){</span>
    <span class="nb">int</span> <span class="n">my_rank</span> <span class="o">=</span> <span class="n">omp_get_thread_num</span><span class="p">();</span> 
    <span class="nb">int</span> <span class="n">num_th</span> <span class="o">=</span> <span class="n">omp_get_num_threads</span><span class="p">();</span> 
    <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;Hola del thread: </span><span class="si">%d</span><span class="s2"> de </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">my_rank</span><span class="p">,</span> <span class="n">num_th</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Writing hello_world_omp.c
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">bash</span>
gcc -Wall -fopenmp hello_world_omp.c -o hello_world_omp.out
</pre></div>
</div>
</div>
</div>
<div class="cell tag_output_scroll docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">bash</span>
./hello_world_omp.out
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Hola del thread: 60 de 64
Hola del thread: 9 de 64
Hola del thread: 6 de 64
Hola del thread: 13 de 64
Hola del thread: 44 de 64
Hola del thread: 15 de 64
Hola del thread: 12 de 64
Hola del thread: 16 de 64
Hola del thread: 18 de 64
Hola del thread: 14 de 64
Hola del thread: 62 de 64
Hola del thread: 17 de 64
Hola del thread: 45 de 64
Hola del thread: 48 de 64
Hola del thread: 23 de 64
Hola del thread: 55 de 64
Hola del thread: 24 de 64
Hola del thread: 42 de 64
Hola del thread: 26 de 64
Hola del thread: 49 de 64
Hola del thread: 0 de 64
Hola del thread: 29 de 64
Hola del thread: 50 de 64
Hola del thread: 34 de 64
Hola del thread: 53 de 64
Hola del thread: 47 de 64
Hola del thread: 19 de 64
Hola del thread: 39 de 64
Hola del thread: 38 de 64
Hola del thread: 36 de 64
Hola del thread: 33 de 64
Hola del thread: 37 de 64
Hola del thread: 43 de 64
Hola del thread: 59 de 64
Hola del thread: 28 de 64
Hola del thread: 21 de 64
Hola del thread: 46 de 64
Hola del thread: 27 de 64
Hola del thread: 25 de 64
Hola del thread: 31 de 64
Hola del thread: 32 de 64
Hola del thread: 41 de 64
Hola del thread: 20 de 64
Hola del thread: 22 de 64
Hola del thread: 35 de 64
Hola del thread: 58 de 64
Hola del thread: 3 de 64
Hola del thread: 4 de 64
Hola del thread: 2 de 64
Hola del thread: 1 de 64
Hola del thread: 5 de 64
Hola del thread: 7 de 64
Hola del thread: 61 de 64
Hola del thread: 10 de 64
Hola del thread: 8 de 64
Hola del thread: 11 de 64
Hola del thread: 51 de 64
Hola del thread: 40 de 64
Hola del thread: 63 de 64
Hola del thread: 30 de 64
Hola del thread: 57 de 64
Hola del thread: 52 de 64
Hola del thread: 54 de 64
Hola del thread: 56 de 64
</pre></div>
</div>
</div>
</div>
<div class="admonition-comentarios admonition">
<p class="admonition-title">Comentarios</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">omp.h</span></code> es un <em>header file</em> con prototipos y definiciones de macros para uso de la librería de funciones y macros de <em>OpenMP</em>.</p></li>
<li><p>La función <code class="docutils literal notranslate"><span class="pre">Hello</span></code> será ejecutada por los <em>threads</em>.</p></li>
<li><p>La función <code class="docutils literal notranslate"><span class="pre">omp_get_thread_num</span></code> da el <em>rank</em> asignado por el <em>run time system</em> a cada <em>thread</em>.</p></li>
<li><p>Con la función <code class="docutils literal notranslate"><span class="pre">omp_get_num_threads</span></code> se obtiene el número de <em>threads</em> que realizaron un <em>fork</em> del <em>thread</em> principal.</p></li>
<li><p>Obsérvese que para la compilación se utilizó la <em>flag</em> <code class="docutils literal notranslate"><span class="pre">-fopenmp</span></code> para soporte de <em>OpenMP</em>.</p></li>
<li><p>Dependiendo del número de <em>cores</em> de nuestro sistema tendremos diferentes número de <code class="docutils literal notranslate"><span class="pre">printf</span></code>’s.</p></li>
<li><p>Lo que continúa a la línea de <code class="docutils literal notranslate"><span class="pre">#pragma</span> <span class="pre">omp</span> <span class="pre">parallel</span></code> es un <em>structured block</em>, esto es, un <em>statement</em> o conjunto de <em>statements</em> que tienen un punto de entrada y un punto de salida. En el caso anterior sólo se llama a la función <code class="docutils literal notranslate"><span class="pre">Hello</span></code>.</p></li>
<li><p>No se permiten <em>statements</em> como el siguiente:</p></li>
</ul>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="cp">#pragma omp parallel</span>

<span class="k">if</span><span class="p">(...)</span> <span class="k">break</span><span class="p">;</span>
</pre></div>
</div>
<p>ni tampoco:</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="cp">#pragma omp parallel</span>

    <span class="p">{</span>
        <span class="k">if</span><span class="p">(</span><span class="n">variable</span> <span class="o">==</span> <span class="n">valor</span><span class="p">)</span> <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">return</span> <span class="mi">-1</span><span class="p">;</span>
    <span class="p">}</span>
</pre></div>
</div>
</div>
<p>A continuación de la directiva <code class="docutils literal notranslate"><span class="pre">parallel</span></code> podemos usar diferentes tipos de <em>clauses</em>. Una <em>clause</em> en <em>OpenMP</em> es un texto que modifica una directiva. Por ejemplo, podemos usar la <em>clause</em> <code class="docutils literal notranslate"><span class="pre">num_threads</span></code> para especificar el número de threads que ejecutarán el <em>structured block</em>.</p>
</div>
<div class="section" id="num-threads-clause">
<h3><code class="docutils literal notranslate"><span class="pre">num_threads</span></code> <em>clause</em><a class="headerlink" href="#num-threads-clause" title="Permalink to this headline">¶</a></h3>
</div>
<div class="section" id="id1">
<h3>Ejemplo<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">hello_world_omp_num_threads.c</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%file</span> hello_world_omp_num_threads.c
<span class="c1">#include&lt;stdio.h&gt;</span>
<span class="c1">#include&lt;stdlib.h&gt;</span>
<span class="c1">#include&lt;omp.h&gt; </span>

<span class="n">void</span> <span class="n">Hello</span><span class="p">(</span><span class="n">void</span><span class="p">);</span> 
<span class="nb">int</span> <span class="n">main</span><span class="p">(){</span>
    <span class="nb">int</span> <span class="n">n_threads</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
    <span class="c1">#pragma omp parallel num_threads(n_threads) </span>
        <span class="n">Hello</span><span class="p">();</span>
    
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">void</span> <span class="n">Hello</span><span class="p">(</span><span class="n">void</span><span class="p">){</span>
    <span class="nb">int</span> <span class="n">my_rank</span> <span class="o">=</span> <span class="n">omp_get_thread_num</span><span class="p">();</span> 
    <span class="nb">int</span> <span class="n">num_th</span> <span class="o">=</span> <span class="n">omp_get_num_threads</span><span class="p">();</span> 
    <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;Hola del thread: </span><span class="si">%d</span><span class="s2"> de </span><span class="si">%d</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">my_rank</span><span class="p">,</span> <span class="n">num_th</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Writing hello_world_omp_num_threads.c
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">bash</span>
gcc -Wall -fopenmp hello_world_omp_num_threads.c -o hello_world_omp_num_threads.out
</pre></div>
</div>
</div>
</div>
<div class="cell tag_output_scroll docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">bash</span>
./hello_world_omp_num_threads.out
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Hola del thread: 0 de 5
Hola del thread: 4 de 5
Hola del thread: 1 de 5
Hola del thread: 3 de 5
Hola del thread: 2 de 5
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="reduction-clause">
<h3><em>Reduction clause</em><a class="headerlink" href="#reduction-clause" title="Permalink to this headline">¶</a></h3>
<p><em>OpenMP</em> provee la <em>reduction clause</em> para aplicar la operación de suma (operador binario) a cada resultado calculado de un <em>thread</em> de forma repetida y almacenar en una variable la respuesta.</p>
<p>Nombramos <em>reduction variable</em> a la variable que almacenará los resultados intermedios calculados por cada <em>thread</em> y <em>reduction operator</em> a la operación binaria (por ejemplo una suma o multiplicación) que se aplica repetidamente a una secuencia de operandos para obtener un resultado, en un proceso que se le nombra <em>reduction</em>.</p>
<p>Por ejemplo, si <code class="docutils literal notranslate"><span class="pre">A</span></code> es un arreglo de <code class="docutils literal notranslate"><span class="pre">n</span></code> enteros, el cálculo:</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="n">sum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">n</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
    <span class="n">sum</span> <span class="o">+=</span> <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</pre></div>
</div>
<p>es un proceso de <em>reduction</em> en el que el <em>reduction operator</em> es la suma.</p>
<p>En openMP utilizamos la <em>reduction clause</em> en la <em>parallel directive</em>.</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="n">sum_shared</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="cp">#pragma omp parallel num_threads(n_threads) reduction(+: sum_shared)</span>
    <span class="n">sum_shared</span> <span class="o">+=</span> <span class="n">Rcf_parallel</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">h_hat</span><span class="p">,</span><span class="n">n_subintervals_per_thread</span><span class="p">);</span>
</pre></div>
</div>
<p>Con la <em>reduction clause</em> openMP crea una variable privada por cada <em>thread</em> y el <em>run time system</em> almacena el resultado de cada <em>thread</em> en esta variable. <em>openMP</em> también crea una <em>critical section</em> y los valores almacenados en las variables privadas son sumadas en esta <em>critical section</em> y almacenados en la <em>reduction variable</em> <code class="docutils literal notranslate"><span class="pre">sum_shared</span></code>. El <em>reduction operator</em> es: <code class="docutils literal notranslate"><span class="pre">+</span></code>.</p>
<p>La sintaxis de la <em>reduction clause</em> es:</p>
<div class="highlight-C notranslate"><div class="highlight"><pre><span></span><span class="n">reduction</span><span class="p">(</span> <span class="o">&lt;</span><span class="n">operator</span><span class="o">&gt;:</span> <span class="o">&lt;</span><span class="n">variable</span> <span class="n">list</span><span class="o">&gt;</span><span class="p">)</span>
</pre></div>
</div>
<p>El <em>reduction operator</em> puede ser cualquiera de los operadores: <code class="docutils literal notranslate"><span class="pre">+,*,-,&amp;,|,^,&amp;&amp;,||</span></code>. Cabe señalar que el proceso de <em>reduction</em> asume que los operadores utilizados cumplen con la propiedad asociativa (por ejemplo, el operador de resta no cumple con esto).</p>
<p>La variable que está en la <em>reduction clause</em> es compartida. Sin embargo una variable privada es creada por cada <em>thread</em> en el <em>team</em> (<strong>con el mismo nombre</strong> que aparece en la <em>reduction clause</em>) y si un <em>thread</em> ejecuta un statement en el <em>parallel block</em> que involucra a la variable, entonces se utiliza la variable privada y al finalizar el <em>parallel block</em>, los valores calculados en las variables privadas son combinados en la variable compartida.</p>
</div>
<div class="section" id="id2">
<h3>Ejemplo<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p>En el siguiente código se muestra el uso de nombres de variables al definir variables privadas y compartidas en una <em>reduction clause</em>.</p>
<p><code class="docutils literal notranslate"><span class="pre">private_shared_variable_reduction_clause_example.c</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%%file private_shared_variable_reduction_clause_example.c
#include&lt;stdio.h&gt;
#include&lt;stdlib.h&gt;
#include&lt;omp.h&gt;

int main(int argc, char *argv[]){
    long n_threads;
    int private_variable;
    int sum_shared = 7;
        
    n_threads = strtol(argv[1], NULL, 10);
    
    printf(&quot;variable sum_shared al inicio : %d\n&quot;, sum_shared);
    
    #pragma omp parallel num_threads(n_threads) reduction(+: sum_shared)
    {
        int my_rank = omp_get_thread_num();
        if(my_rank==0)
            printf(&quot;sum_shared, printf 1 del thread 0: %d\n&quot;, sum_shared);
        else
            printf(&quot;sum_shared, prinftf 1 thread 1: %d\n&quot;, sum_shared);
        sum_shared = (my_rank==0)?10:20;
        if(my_rank==0)
            printf(&quot;sum_shared, printf 2 del thread 0: %d\n&quot;, sum_shared);
        else
            printf(&quot;sum_shared, printf 2 del thread 1: %d\n&quot;, sum_shared);
        private_variable = (my_rank==0)?1:2;
        sum_shared += private_variable;
        if(my_rank==0)
            printf(&quot;sum_shared, printf 3 del thread 0: %d\n&quot;, sum_shared);
        else
            printf(&quot;sum_shared, printf 3 del thread 1: %d\n&quot;, sum_shared);
    
    }
    printf(&quot;sum_shared al final de la directive parallel %d\n&quot;, sum_shared);
    
    return 0;
}
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Writing private_shared_variable_reduction_clause_example.c
</pre></div>
</div>
</div>
</div>
<p>Compilamos:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">bash</span>
gcc -Wall -fopenmp private_shared_variable_reduction_clause_example.c -o private_shared_variable_reduction_clause_example.out 
</pre></div>
</div>
</div>
</div>
<p>Ejecutamos:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">bash</span>
./private_shared_variable_reduction_clause_example.out 2
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>variable sum_shared al inicio : 7
sum_shared, printf 1 del thread 0: 0
sum_shared, printf 2 del thread 0: 10
sum_shared, printf 3 del thread 0: 11
sum_shared, prinftf 1 thread 1: 0
sum_shared, printf 2 del thread 1: 20
sum_shared, printf 3 del thread 1: 22
sum_shared al final de la directive parallel 40
</pre></div>
</div>
</div>
</div>
<div class="admonition-comentario admonition">
<p class="admonition-title">Comentario</p>
<p>La variable <code class="docutils literal notranslate"><span class="pre">sum_shared</span></code> se inicializa en 0. En general, las variables privadas creadas para una <em>reduction clause</em> son inicializadas al <em>identity value</em> para el <em>operator</em>. Por ejemplo, si el <em>operator</em> es la multiplicación, entonces las variables privadas son inicializadas en 1.</p>
</div>
</div>
<div class="section" id="ejemplo-regla-compuesta-del-rectangulo">
<h3>Ejemplo regla compuesta del rectángulo<a class="headerlink" href="#ejemplo-regla-compuesta-del-rectangulo" title="Permalink to this headline">¶</a></h3>
<p>1.<em>Partitioning</em>: la tarea a realizar es el cálculo de un área de un rectángulo para un subintervalo.</p>
<img src="https://dl.dropboxusercontent.com/s/5nqciu6ca5xzdh9/parallel_processing_Rcf_1.png?dl=0" heigth="300" width="400"><p>2.<em>Communication</em> y <em>mapping</em>: los subintervalos deben repartirse entre los <em>cores</em> y se debe comunicar esta repartición por algún medio (por ejemplo con variables en memoria).</p>
<p>3.<em>Aggregation</em>: un <em>core</em> puede calcular más de un área de un rectángulo si recibe más de un subintervalo.</p>
<img src="https://dl.dropboxusercontent.com/s/lpcwd9mejb90rq3/parallel_processing_Rcf_2.png?dl=0" heigth="200" width="300">
<p>4.<em>Communication</em> y <em>mapping</em>: el área de los rectángulos calculados por cada procesador deben sumarse para calcular la aproximación a la integral.</p>
<img src="https://dl.dropboxusercontent.com/s/mfo5rfzjnonn8lq/parallel_processing_Rcf_3.png?dl=0" heigth="400" width="500">
<p>Para la medición de tiempos se utilizaron las ligas: <a class="reference external" href="https://stackoverflow.com/questions/16764276/measuring-time-in-millisecond-precision">measuring-time-in-millisecond-precision</a> y <a class="reference external" href="https://www.techiedelight.com/find-execution-time-c-program/">find-execution-time-c-program</a>.</p>
<p><code class="docutils literal notranslate"><span class="pre">Rcf_parallel.c</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%file</span> Rcf_parallel.c
<span class="c1">#include&lt;stdio.h&gt;</span>
<span class="c1">#include&lt;stdlib.h&gt;</span>
<span class="c1">#include&lt;omp.h&gt;</span>
<span class="c1">#include&lt;math.h&gt; </span>
<span class="c1">#include&lt;time.h&gt;</span>
<span class="c1">#include &lt;sys/time.h&gt;</span>

<span class="n">double</span> <span class="n">Rcf</span><span class="p">(</span><span class="n">double</span> <span class="n">a</span><span class="p">,</span> <span class="n">double</span> <span class="n">h_hat</span><span class="p">,</span> <span class="nb">int</span> <span class="n">ns_p</span><span class="p">);</span>

<span class="n">double</span> <span class="n">f</span><span class="p">(</span><span class="n">double</span> <span class="n">node</span><span class="p">);</span>

<span class="nb">int</span> <span class="n">main</span><span class="p">(){</span>
    <span class="n">double</span> <span class="n">sum_shared</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span> <span class="o">//</span><span class="n">shared</span> <span class="n">variable</span> <span class="k">for</span> <span class="n">threads</span>
    <span class="n">double</span> <span class="n">a</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">;</span>
    <span class="nb">int</span> <span class="n">n</span> <span class="o">=</span> <span class="mf">1e7</span><span class="p">;</span> <span class="o">//</span><span class="n">number</span> <span class="n">of</span> <span class="n">subintervals</span>
    <span class="n">double</span> <span class="n">h_hat</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">/</span><span class="n">n</span><span class="p">;</span>
    <span class="nb">int</span> <span class="n">n_subintervals_per_thread</span><span class="p">;</span> <span class="o">//</span><span class="n">number</span> <span class="n">of</span> <span class="n">subintervals</span> <span class="n">assigned</span> <span class="n">to</span> <span class="n">each</span> <span class="n">thread</span>
    <span class="nb">int</span> <span class="n">n_threads</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span><span class="o">//</span><span class="n">each</span> <span class="n">entry</span> <span class="n">of</span> <span class="n">n_threads</span> <span class="n">must</span> <span class="n">divide</span> <span class="n">n</span> <span class="n">variable</span> <span class="n">exactly</span>
    <span class="nb">int</span> <span class="n">len_n_threads_array</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">double</span> <span class="n">obj</span> <span class="o">=</span> <span class="mf">0.7468241328124271</span><span class="p">;</span>
    <span class="n">struct</span> <span class="n">timeval</span> <span class="n">start</span><span class="p">;</span>
    <span class="n">struct</span> <span class="n">timeval</span> <span class="n">end</span><span class="p">;</span>
    <span class="n">long</span> <span class="n">seconds</span><span class="p">;</span>
    <span class="n">long</span> <span class="n">long</span> <span class="n">mili</span><span class="p">;</span>
    <span class="nb">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">n_threads</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">n_threads</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">n_threads</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
    <span class="n">n_threads</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
    <span class="n">n_threads</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
    <span class="n">n_threads</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
    <span class="n">n_threads</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
    <span class="n">len_n_threads_array</span> <span class="o">=</span> <span class="n">sizeof</span><span class="p">(</span><span class="n">n_threads</span><span class="p">)</span><span class="o">/</span><span class="n">sizeof</span><span class="p">(</span><span class="n">n_threads</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">len_n_threads_array</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
        <span class="n">n_subintervals_per_thread</span> <span class="o">=</span> <span class="n">n</span><span class="o">/</span><span class="n">n_threads</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="n">gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">start</span><span class="p">,</span> <span class="n">NULL</span><span class="p">);</span>
        <span class="c1">#pragma omp parallel num_threads(n_threads[i]) reduction(+: sum_shared)</span>
            <span class="n">sum_shared</span> <span class="o">+=</span> <span class="n">Rcf</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">h_hat</span><span class="p">,</span><span class="n">n_subintervals_per_thread</span><span class="p">);</span>
        <span class="n">sum_shared</span> <span class="o">=</span> <span class="n">h_hat</span><span class="o">*</span><span class="n">sum_shared</span><span class="p">;</span>
        <span class="n">gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">end</span><span class="p">,</span> <span class="n">NULL</span><span class="p">);</span>
        <span class="n">seconds</span> <span class="o">=</span> <span class="p">(</span><span class="n">end</span><span class="o">.</span><span class="n">tv_sec</span> <span class="o">-</span> <span class="n">start</span><span class="o">.</span><span class="n">tv_sec</span><span class="p">);</span>
        <span class="n">mili</span> <span class="o">=</span> <span class="mi">1000</span><span class="o">*</span><span class="p">(</span><span class="n">seconds</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">end</span><span class="o">.</span><span class="n">tv_usec</span> <span class="o">-</span> <span class="n">start</span><span class="o">.</span><span class="n">tv_usec</span><span class="p">)</span><span class="o">/</span><span class="mi">1000</span><span class="p">;</span>
        <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;Integral de </span><span class="si">%f</span><span class="s2"> a </span><span class="si">%f</span><span class="s2"> = </span><span class="si">%1.15e</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">sum_shared</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;Error relativo de la solución: </span><span class="si">%1.15e</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fabs</span><span class="p">(</span><span class="n">sum_shared</span><span class="o">-</span><span class="n">obj</span><span class="p">)</span><span class="o">/</span><span class="n">fabs</span><span class="p">(</span><span class="n">obj</span><span class="p">));</span>
        <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;Tiempo de ejecución con </span><span class="si">%d</span><span class="s2"> threads: %lld miliseconds</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">n_threads</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">mili</span><span class="p">);</span>
        <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;----------------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">);</span>
        <span class="n">sum_shared</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">double</span> <span class="n">Rcf</span><span class="p">(</span><span class="n">double</span> <span class="n">a</span><span class="p">,</span> <span class="n">double</span> <span class="n">h_hat</span><span class="p">,</span> <span class="nb">int</span> <span class="n">n_s_t</span><span class="p">){</span>
    <span class="nb">int</span> <span class="n">begin</span><span class="p">,</span> <span class="n">end</span><span class="p">;</span>
    <span class="nb">int</span> <span class="n">my_rank</span> <span class="o">=</span> <span class="n">omp_get_thread_num</span><span class="p">();</span>
    <span class="n">double</span> <span class="n">local_int</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="nb">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">double</span> <span class="n">x</span><span class="p">;</span>
    <span class="n">begin</span> <span class="o">=</span> <span class="n">my_rank</span><span class="o">*</span><span class="n">n_s_t</span><span class="p">;</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">begin</span> <span class="o">+</span> <span class="n">n_s_t</span><span class="p">;</span> 
    <span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="n">begin</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;=</span><span class="n">end</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">a</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span><span class="o">*</span><span class="n">h_hat</span><span class="p">;</span>
        <span class="n">local_int</span> <span class="o">+=</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
    <span class="p">}</span>   
    <span class="k">return</span> <span class="n">local_int</span><span class="p">;</span>
<span class="p">}</span>
        
<span class="n">double</span> <span class="n">f</span><span class="p">(</span><span class="n">double</span> <span class="n">node</span><span class="p">){</span>
    <span class="n">double</span> <span class="n">f_value</span><span class="p">;</span>
    <span class="n">f_value</span> <span class="o">=</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="nb">pow</span><span class="p">(</span><span class="n">node</span><span class="p">,</span><span class="mi">2</span><span class="p">));</span>
    <span class="k">return</span> <span class="n">f_value</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Writing Rcf_parallel.c
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">bash</span>
gcc -Wall -fopenmp Rcf_parallel.c -o Rcf_parallel.out -lm
</pre></div>
</div>
</div>
</div>
<div class="cell tag_output_scroll docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">bash</span>
./Rcf_parallel.out
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Integral de 0.000000 a 1.000000 = 7.468241328123898e-01
Error relativo de la solución: 4.994950214975770e-14
Tiempo de ejecución con 1 threads: 492 miliseconds
----------------------
Integral de 0.000000 a 1.000000 = 7.468241328124163e-01
Error relativo de la solución: 1.441994556109076e-14
Tiempo de ejecución con 2 threads: 239 miliseconds
----------------------
Integral de 0.000000 a 1.000000 = 7.468241328124452e-01
Error relativo de la solución: 2.423145491193603e-14
Tiempo de ejecución con 4 threads: 121 miliseconds
----------------------
Integral de 0.000000 a 1.000000 = 7.468241328124374e-01
Error relativo de la solución: 1.382530863073651e-14
Tiempo de ejecución con 8 threads: 60 miliseconds
----------------------
Integral de 0.000000 a 1.000000 = 7.468241328124300e-01
Error relativo de la solución: 3.865140047302680e-15
Tiempo de ejecución con 16 threads: 30 miliseconds
----------------------
Integral de 0.000000 a 1.000000 = 7.468241328124294e-01
Error relativo de la solución: 3.121843884359856e-15
Tiempo de ejecución con 32 threads: 21 miliseconds
----------------------
Integral de 0.000000 a 1.000000 = 7.468241328124262e-01
Error relativo de la solución: 1.189273860708517e-15
Tiempo de ejecución con 64 threads: 26 miliseconds
----------------------
</pre></div>
</div>
</div>
</div>
<div class="admonition-comentarios admonition">
<p class="admonition-title">Comentarios</p>
<ul class="simple">
<li><p>Dividimos el número de subintervalos <code class="docutils literal notranslate"><span class="pre">n</span></code> entre el número de <em>threads</em> que deseamos lanzar, por esto, <code class="docutils literal notranslate"><span class="pre">n</span></code> debe ser <strong>divisible</strong> entre las entradas del <em>array</em> <code class="docutils literal notranslate"><span class="pre">n_threads</span></code>. Esta cantidad es el número de subintervalos contiguos que le corresponden a cada <em>thread</em>.</p></li>
<li><p>Además, se debe de agregar el resultado de la suma de cada <em>thread</em>. Esto es posible realizar de forma sencilla definiendo una variable que sea compartida. Al definir tal variable en la función <em>main</em> y antes de un <em>parallel block</em> el <em>default</em> es que sea considerada como compartida.</p></li>
<li><p>Las variables que son privadas se definen en la función <code class="docutils literal notranslate"><span class="pre">Rcf</span></code>.</p></li>
</ul>
</div>
</div>
<div class="section" id="directiva-parallel-for">
<h3>Directiva <em>parallel for</em><a class="headerlink" href="#directiva-parallel-for" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Esta directiva ayuda a paralelizar ciclos <em>for</em> que tienen una forma canónica como sigue:</p></li>
</ul>
<img src="https://dl.dropboxusercontent.com/s/qw1dui3gfewl2jx/for_canonico_openmp.jpg?dl=0" heigth="600" width="600"><ul class="simple">
<li><p>La directiva realiza un <em>fork</em> de <em>threads</em> en un <em>team</em> para ejecutar el <em>structured block</em> que continúa a la directiva. Tal <em>structured block</em> debe ser un ciclo <em>for</em>.</p></li>
<li><p>Con esta directiva se dividen las iteraciones del <em>loop</em> entre los <em>threads</em>.</p></li>
<li><p>Por <em>default</em> todas las variables definidas antes de la directiva <em>parallel</em> son compartidas pero en la directiva <em>parallel for</em>, el índice del ciclo <em>for</em> es privada, cada <em>thread</em> tiene su propia copia de tal índice.</p></li>
</ul>
</div>
<div class="section" id="ejemplo-regla-compuesta-del-rectangulo-con-directiva-parallel-for">
<h3>Ejemplo regla compuesta del rectángulo con directiva <em>parallel for</em><a class="headerlink" href="#ejemplo-regla-compuesta-del-rectangulo-con-directiva-parallel-for" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%file</span> Rcf_parallel_for.c
<span class="c1">#include&lt;stdio.h&gt;</span>
<span class="c1">#include&lt;stdlib.h&gt;</span>
<span class="c1">#include&lt;math.h&gt;</span>
<span class="c1">#include&lt;time.h&gt;</span>
<span class="c1">#include &lt;sys/time.h&gt;</span>

<span class="n">double</span> <span class="n">Rcf</span><span class="p">(</span><span class="n">long</span> <span class="n">n_t</span><span class="p">,</span> <span class="n">double</span> <span class="n">ext_izq</span><span class="p">,</span> <span class="n">double</span> <span class="n">ext_der</span><span class="p">,</span> <span class="nb">int</span> <span class="n">n</span><span class="p">,</span>\
           <span class="n">double</span> <span class="n">s_res</span><span class="p">);</span>
<span class="n">double</span> <span class="n">f</span><span class="p">(</span><span class="n">double</span> <span class="n">nodo</span><span class="p">);</span>

<span class="nb">int</span> <span class="n">main</span><span class="p">(</span><span class="nb">int</span> <span class="n">argc</span><span class="p">,</span> <span class="n">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[]){</span>
    <span class="n">double</span> <span class="n">sum_res</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
    <span class="n">double</span> <span class="n">a</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">;</span>
    <span class="nb">int</span> <span class="n">n</span> <span class="o">=</span> <span class="mf">1e7</span><span class="p">;</span>
    <span class="n">struct</span> <span class="n">timeval</span> <span class="n">start</span><span class="p">;</span>
    <span class="n">struct</span> <span class="n">timeval</span> <span class="n">end</span><span class="p">;</span>
    <span class="n">long</span> <span class="n">seconds</span><span class="p">;</span>
    <span class="n">long</span> <span class="n">long</span> <span class="n">mili</span><span class="p">;</span>
    <span class="n">long</span> <span class="n">n_threads</span><span class="p">;</span>
    <span class="n">double</span> <span class="n">res_rcf</span><span class="p">;</span>
    
    <span class="n">n_threads</span> <span class="o">=</span> <span class="n">strtol</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>   
    <span class="n">gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">start</span><span class="p">,</span> <span class="n">NULL</span><span class="p">);</span>
    <span class="n">res_rcf</span> <span class="o">=</span> <span class="n">Rcf</span><span class="p">(</span><span class="n">n_threads</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">n</span><span class="p">,</span> <span class="n">sum_res</span><span class="p">);</span>
    <span class="n">gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">end</span><span class="p">,</span> <span class="n">NULL</span><span class="p">);</span>
    <span class="n">seconds</span> <span class="o">=</span> <span class="p">(</span><span class="n">end</span><span class="o">.</span><span class="n">tv_sec</span> <span class="o">-</span> <span class="n">start</span><span class="o">.</span><span class="n">tv_sec</span><span class="p">);</span>
    <span class="n">mili</span> <span class="o">=</span> <span class="mi">1000</span><span class="o">*</span><span class="p">(</span><span class="n">seconds</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">end</span><span class="o">.</span><span class="n">tv_usec</span> <span class="o">-</span> <span class="n">start</span><span class="o">.</span><span class="n">tv_usec</span><span class="p">)</span><span class="o">/</span><span class="mi">1000</span><span class="p">;</span>    
    <span class="n">printf</span><span class="p">(</span><span class="s2">&quot;Tiempo de ejecución: %lld milisegundos&quot;</span><span class="p">,</span> <span class="n">mili</span><span class="p">);</span>
    
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">double</span> <span class="n">Rcf</span><span class="p">(</span><span class="n">long</span> <span class="n">n_th</span><span class="p">,</span> <span class="n">double</span> <span class="n">a</span><span class="p">,</span> <span class="n">double</span> <span class="n">b</span><span class="p">,</span> <span class="nb">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">double</span> <span class="nb">sum</span><span class="p">){</span>
    <span class="n">double</span> <span class="n">h_hat</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">/</span><span class="n">n</span><span class="p">;</span>
    <span class="n">double</span> <span class="n">x</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
    <span class="nb">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="nb">sum</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
    <span class="c1"># pragma omp parallel for num_threads(n_th) reduction(+: sum)</span>
        <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">a</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span><span class="o">*</span><span class="n">h_hat</span><span class="p">;</span>
            <span class="nb">sum</span> <span class="o">+=</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="k">return</span> <span class="n">h_hat</span><span class="o">*</span><span class="nb">sum</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">double</span> <span class="n">f</span><span class="p">(</span><span class="n">double</span> <span class="n">nodo</span><span class="p">){</span>
    <span class="n">double</span> <span class="n">valor_f</span><span class="p">;</span>
    <span class="n">valor_f</span> <span class="o">=</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="nb">pow</span><span class="p">(</span><span class="n">nodo</span><span class="p">,</span><span class="mi">2</span><span class="p">));</span>
    <span class="k">return</span> <span class="n">valor_f</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Writing Rcf_parallel_for.c
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">bash</span>
gcc -Wall -fopenmp Rcf_parallel_for.c -o Rcf_parallel_for.out -lm
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Rcf_parallel_for.c: In function ‘main’:
Rcf_parallel_for.c:20:12: warning: variable ‘res_rcf’ set but not used [-Wunused-but-set-variable]
   20 |     double res_rcf;
      |            ^~~~~~~
</pre></div>
</div>
</div>
</div>
<div class="cell tag_output_scroll docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">bash</span>
./Rcf_parallel_for.out 32
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Tiempo de ejecución: 167 milisegundos
</pre></div>
</div>
</div>
</div>
<div class="tip admonition">
<p class="admonition-title">Ejercicio</p>
<p>Implementar la regla de Simpson compuesta con <em>OpenMP</em> utilizando una <em>reduction clause</em> y la directiva <em>parallel for</em> en una máquina de AWS con las mismas características que la que se presenta en esta nota y medir tiempo de ejecución.</p>
</div>
</div>
</div>
<div class="section" id="multiprocessing">
<h2><a class="reference external" href="https://docs.python.org/3.1/library/multiprocessing.html">Multiprocessing</a><a class="headerlink" href="#multiprocessing" title="Permalink to this headline">¶</a></h2>
<p>El módulo <em>Multiprocessing</em> permite realizar procesamientos basados en procesos o <em>threads</em> para compartir trabajo, datos y lidiar con que la implementación estándar de Python, <a class="reference external" href="https://github.com/python/cpython">CPython</a> no utiliza múltiples <em>cores</em> por <em>default</em> para procesamiento.</p>
<ul class="simple">
<li><p>En el apartado de <a class="reference external" href="https://en.wikipedia.org/wiki/CPython">Cpython-Design</a> se menciona el por qué CPython no soporta ejecución <em>multithreaded</em> o <em>multiprocesses</em> y a continuación se colocan unos párrafos de tal discusión.</p></li>
</ul>
<p><em>A particular feature of CPython is that it makes use of a global interpreter lock (GIL) on each CPython interpreter process, which means that within a single process, only one thread may be processing Python bytecode at any one time. This does not mean that there is no point in multithreading; the most common multithreading scenario is where threads are mostly waiting on external processes to complete.</em></p>
<p><em>For example, imagine when three threads are servicing separate clients. One thread may be waiting for a client to reply, and another may be waiting for a database query to execute, while the third thread is actually processing Python code.</em></p>
<p><em>However, the GIL does mean that CPython is not suitable for processes that implement CPU-intensive algorithms in Python code that could potentially be distributed across multiple cores. …</em></p>
<ul class="simple">
<li><p>Se recomienda usar este módulo para el <em>shared memory programming</em> y para trabajos que son demandantes de CPU. No se recomienda su uso en trabajos demandantes en I/O. En su lugar se tienen paquetes de <em>Python</em> para ejecución del código de forma asíncrona como <a class="reference external" href="https://docs.python.org/3/library/asyncio.html">asyncio</a> o <a class="reference external" href="https://www.tornadoweb.org/en/stable/">tornado</a>.</p></li>
</ul>
<div class="admonition-comentario admonition">
<p class="admonition-title">Comentario</p>
<p>Otro módulo en <em>Python</em> para procesamiento en un SMC con CPUs es <a class="reference external" href="https://docs.python.org/3/library/concurrent.futures.html">concurrent.futures</a> que provee el comportamiento principal de <em>Multiprocessing</em>. Ver <a class="reference external" href="https://stackoverflow.com/questions/38311431/concurrent-futures-processpoolexecutor-vs-multiprocessing-pool-pool?noredirect=1&amp;lq=1">concurrent-futures-processpoolexecutor-vs-multiprocessing-pool-pool</a> y <a class="reference external" href="https://stackoverflow.com/questions/20776189/concurrent-futures-vs-multiprocessing-in-python-3">concurrent-futures-vs-multiprocessing-in-python-3</a> para más sobre <em>concurrent.futures</em> y <em>concurrent.futures</em> vs <em>multiprocessing</em>.</p>
</div>
<div class="section" id="nota-sobre-el-gil-y-multiprocessing">
<h3>Nota sobre el GIL y <em>multiprocessing</em><a class="headerlink" href="#nota-sobre-el-gil-y-multiprocessing" title="Permalink to this headline">¶</a></h3>
<p>Aunque en <em>Python</em> los <em>threads</em> son nativos del sistema operativo (esto es, no se simulan, son realmente <em>threads</em> del sistema operativo creados en el hardware), están limitados por el <em>global interpreter lock</em> (GIL), de modo que un sólo <em>thread</em> interactúe con un objeto Python en un único tiempo. Esto degrada el <em>performance</em> de los programas pues si un <em>thread</em> con etiqueta 1 tiene el GIL entonces otro <em>thread</em> con etiqueta 2 esperará hasta que el <em>thread</em> 1 lo suelte. Ver <a class="reference external" href="http://www.dabeaz.com/GIL/">Understanding the Python GIL</a>.</p>
<p>Al usar el módulo <em>Multiprocessing</em> ejecutamos en paralelo un número de intérpretes <em>Python</em> (CPython), cada uno con su propio espacio de memoria privada y su propio GIL.</p>
<div class="tip admonition">
<p class="admonition-title">Observación</p>
<p>En <em>multiprocessing</em> se utilizan subprocesos en lugar de <em>threads</em> y en lugar de <em>fork</em> se realiza <em>spawn</em>.</p>
</div>
</div>
<div class="section" id="id3">
<h3>Ejemplo<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p>En <em>Multiprocessing</em> los procesos son generados al utilizar la clase <code class="docutils literal notranslate"><span class="pre">Process</span></code> para crear objetos y llamar al método <code class="docutils literal notranslate"><span class="pre">start</span></code>. Ver <a class="reference external" href="https://docs.python.org/3.1/library/multiprocessing.html#multiprocessing.Process">Process</a> para documentación de ésta clase.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;hello world! de subproceso&#39;</span><span class="p">)</span>
    
<span class="n">p1</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
<span class="n">p2</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
<span class="n">p1</span><span class="o">.</span><span class="n">start</span><span class="p">()</span> 
<span class="n">p2</span><span class="o">.</span><span class="n">start</span><span class="p">()</span> 
<span class="n">p1</span><span class="o">.</span><span class="n">join</span><span class="p">()</span> 
<span class="n">p2</span><span class="o">.</span><span class="n">join</span><span class="p">()</span> 
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;hello world! de proceso&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>hello world! de subproceso
hello world! de subproceso
hello world! de proceso
</pre></div>
</div>
</div>
</div>
<div class="admonition-comentarios admonition">
<p class="admonition-title">Comentarios</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">start</span></code> sólo puede ser llamada una vez por objeto <code class="docutils literal notranslate"><span class="pre">Process</span></code>.</p></li>
<li><p>Con el primer <code class="docutils literal notranslate"><span class="pre">join</span></code> el proceso principal espera a que termine <code class="docutils literal notranslate"><span class="pre">p1</span></code>. Con el segundo <code class="docutils literal notranslate"><span class="pre">join</span></code> el proceso principal espera a que termine <code class="docutils literal notranslate"><span class="pre">p2</span></code>.</p></li>
</ul>
</div>
<div class="tip admonition">
<p class="admonition-title">Observación</p>
<p>Es buena práctica explícitamente hacer <em>joins</em> para cada objeto <em>process</em> que realizó <code class="docutils literal notranslate"><span class="pre">start</span></code>. Ver <a class="reference external" href="https://docs.python.org/3.9/library/multiprocessing.html#programming-guidelines">Programming guidelines</a> para buenas prácticas.</p>
</div>
<p>La clase <code class="docutils literal notranslate"><span class="pre">Process</span></code> recibe la función a ejecutar para cada proceso con el argumento <code class="docutils literal notranslate"><span class="pre">target</span></code> y también tiene <code class="docutils literal notranslate"><span class="pre">args</span></code> para los argumentos de la función:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    
<span class="n">p1</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;hola&#39;</span><span class="p">,))</span>
<span class="n">p2</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;mundo&#39;</span><span class="p">,))</span> 
<span class="n">p1</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="n">p2</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="n">p1</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
<span class="n">p2</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>hola
mundo
</pre></div>
</div>
</div>
</div>
<div class="admonition-comentarios admonition">
<p class="admonition-title">Comentarios</p>
<ul class="simple">
<li><p>De acuerdo a <a class="reference external" href="https://docs.python.org/3.1/library/multiprocessing.html#programming-guidelines">Programming guidelines</a> se debe usar un bloque del tipo <code class="docutils literal notranslate"><span class="pre">if</span> <span class="pre">__name__=='__main__':</span></code> para las personas que tienen Windows puedan ejecutar sin problema el código:</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="vm">__name__</span><span class="o">==</span><span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;hola&#39;</span><span class="p">,))</span>
    <span class="n">p2</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;mundo&#39;</span><span class="p">,))</span> 
    <span class="n">p1</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">p2</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">p1</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
    <span class="n">p2</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</pre></div>
</div>
<p>El bloque del <code class="docutils literal notranslate"><span class="pre">if</span></code> ayuda a que los subprocesos importen el módulo <code class="docutils literal notranslate"><span class="pre">__main__</span></code> (por lo que no se ejecuta la sección que está dentro de <code class="docutils literal notranslate"><span class="pre">if</span> <span class="pre">__name__=='__main__':</span></code> pues no son programas principales) y continúa la ejecución de las líneas de <code class="docutils literal notranslate"><span class="pre">start</span></code> (cada subproceso ejecuta <code class="docutils literal notranslate"><span class="pre">f</span></code>) y <code class="docutils literal notranslate"><span class="pre">join</span></code>. Sin tal bloque <code class="docutils literal notranslate"><span class="pre">if</span></code>, el <em>notebook</em> quedará bloqueado pues una celda con el código anterior creará subprocesos que a su vez crearán otros subprocesos, que a su vez crearán otros subprocesos… y así de forma recursiva.</p>
<ul class="simple">
<li><p>Los argumentos en <code class="docutils literal notranslate"><span class="pre">args</span></code> de <code class="docutils literal notranslate"><span class="pre">Process</span></code> tienen que ser objetos <em>pickable</em> o serializados. Ver <a class="reference external" href="https://docs.python.org/3/library/pickle.html#what-can-be-pickled-and-unpickled">what can be pickled and unpickled</a> para una lista de objetos <em>pickable</em>.</p></li>
</ul>
</div>
<p>En <em>Multiprocessing</em> tenemos la función <code class="docutils literal notranslate"><span class="pre">cpu_count</span></code> para determinar el número de <em>cores</em> que el sistema operativo puede usar. Este número es la cantidad física o simulada (<em>hyperthreading</em>) de <em>cores</em>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">multiprocessing</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>64
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="pool-of-workers">
<h3><em>Pool of workers</em><a class="headerlink" href="#pool-of-workers" title="Permalink to this headline">¶</a></h3>
<p>Ver <a class="reference external" href="https://docs.python.org/3/library/multiprocessing.html#using-a-pool-of-workers">Using a pool of workers</a>.</p>
<p>La clase <code class="docutils literal notranslate"><span class="pre">Pool</span></code> crea un conjunto (<em>pool</em>) de procesos tipo <em>worker</em> que procesarán las tareas a realizar vía funciones tipo <code class="docutils literal notranslate"><span class="pre">map</span></code> o <code class="docutils literal notranslate"><span class="pre">apply</span></code>. Se hace <code class="docutils literal notranslate"><span class="pre">map</span></code> del <em>input</em> hacia los procesadores y se colecta el <em>output</em> de éstos. Mientras el <code class="docutils literal notranslate"><span class="pre">map</span></code> se realiza, el proceso que lanzó el <code class="docutils literal notranslate"><span class="pre">map</span></code> se bloquea hasta que finalicen las tareas (aunque hay <a class="reference external" href="https://docs.python.org/3.1/library/multiprocessing.html#multiprocessing.pool.multiprocessing.Pool.map_async">map_async</a>). El <em>output</em> es una lista.</p>
<div class="tip admonition">
<p class="admonition-title">Observación</p>
<p>El procesamiento de las tareas podríamos hacerlo con la clase <code class="docutils literal notranslate"><span class="pre">Process</span></code> de arriba pero tendríamos que utilizar un ciclo y colectar los resultados.</p>
</div>
<div class="admonition-comentario admonition">
<p class="admonition-title">Comentario</p>
<p>Para un gran número de tareas a realizar, utilizar <code class="docutils literal notranslate"><span class="pre">Pool</span></code>. Para pocas tareas (menos de <span class="math notranslate nohighlight">\(10\)</span>) a realizar, utilizar <code class="docutils literal notranslate"><span class="pre">Process</span></code>.</p>
</div>
</div>
<div class="section" id="id4">
<h3>Ejemplo<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Pool</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">dummy</span><span class="p">):</span>
    <span class="k">return</span> <span class="s1">&#39;hello world!&#39;</span>
    
<span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">())</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="nb">range</span><span class="p">(</span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
<span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>    
<span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;hello world!&#39;, &#39;hello world!&#39;, &#39;hello world!&#39;, &#39;hello world!&#39;, &#39;hello world!&#39;, &#39;hello world!&#39;, &#39;hello world!&#39;, &#39;hello world!&#39;, &#39;hello world!&#39;, &#39;hello world!&#39;, &#39;hello world!&#39;, &#39;hello world!&#39;, &#39;hello world!&#39;, &#39;hello world!&#39;, &#39;hello world!&#39;, &#39;hello world!&#39;, &#39;hello world!&#39;, &#39;hello world!&#39;, &#39;hello world!&#39;, &#39;hello world!&#39;, &#39;hello world!&#39;, &#39;hello world!&#39;, &#39;hello world!&#39;, &#39;hello world!&#39;, &#39;hello world!&#39;, &#39;hello world!&#39;, &#39;hello world!&#39;, &#39;hello world!&#39;, &#39;hello world!&#39;, &#39;hello world!&#39;, &#39;hello world!&#39;, &#39;hello world!&#39;, &#39;hello world!&#39;, &#39;hello world!&#39;, &#39;hello world!&#39;, &#39;hello world!&#39;, &#39;hello world!&#39;, &#39;hello world!&#39;, &#39;hello world!&#39;, &#39;hello world!&#39;, &#39;hello world!&#39;, &#39;hello world!&#39;, &#39;hello world!&#39;, &#39;hello world!&#39;, &#39;hello world!&#39;, &#39;hello world!&#39;, &#39;hello world!&#39;, &#39;hello world!&#39;, &#39;hello world!&#39;, &#39;hello world!&#39;, &#39;hello world!&#39;, &#39;hello world!&#39;, &#39;hello world!&#39;, &#39;hello world!&#39;, &#39;hello world!&#39;, &#39;hello world!&#39;, &#39;hello world!&#39;, &#39;hello world!&#39;, &#39;hello world!&#39;, &#39;hello world!&#39;, &#39;hello world!&#39;, &#39;hello world!&#39;, &#39;hello world!&#39;, &#39;hello world!&#39;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">dummy</span><span class="p">):</span>
    <span class="k">return</span> <span class="s1">&#39;hello world!&#39;</span>
    
<span class="n">num_processes</span><span class="o">=</span><span class="mi">2</span>
<span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="n">num_processes</span><span class="p">)</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="nb">range</span><span class="p">(</span><span class="n">num_processes</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
<span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>    
<span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;hello world!&#39;, &#39;hello world!&#39;]
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="ejemplo-utilizando-apply">
<h3>Ejemplo utilizando <code class="docutils literal notranslate"><span class="pre">apply</span></code><a class="headerlink" href="#ejemplo-utilizando-apply" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f</span><span class="p">():</span>
    <span class="k">return</span> <span class="s1">&#39;hello world!&#39;</span>
    
<span class="n">num_processes</span><span class="o">=</span><span class="mi">2</span>
<span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="n">num_processes</span><span class="p">)</span>
<span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">pool</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_processes</span><span class="p">)]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
<span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>    
<span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;hello world!&#39;, &#39;hello world!&#39;]
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="ejemplo-con-context-manager">
<h3>Ejemplo con <a class="reference external" href="https://book.pythontips.com/en/latest/context_managers.html#context-managers">context manager</a><a class="headerlink" href="#ejemplo-con-context-manager" title="Permalink to this headline">¶</a></h3>
<p>Nos ayuda a no escribir <em>statements</em>: <code class="docutils literal notranslate"><span class="pre">pool.close</span></code>, <code class="docutils literal notranslate"><span class="pre">pool.join</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">dummy</span><span class="p">):</span>
    <span class="k">return</span> <span class="s1">&#39;hello world!&#39;</span>
    
<span class="n">num_processes</span><span class="o">=</span><span class="mi">2</span>
<span class="k">with</span> <span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">num_processes</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="nb">range</span><span class="p">(</span><span class="n">num_processes</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;hello world!&#39;, &#39;hello world!&#39;]
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="ejemplo-para-pasar-multiples-argumentos-via-starmap">
<h3>Ejemplo para pasar múltiples argumentos vía <a class="reference external" href="https://docs.python.org/3/library/multiprocessing.html#multiprocessing.pool.Pool.starmap">starmap</a><a class="headerlink" href="#ejemplo-para-pasar-multiples-argumentos-via-starmap" title="Permalink to this headline">¶</a></h3>
<div class="margin sidebar">
<p class="sidebar-title"></p>
<p>Ver <a class="reference external" href="https://docs.python.org/3.9/library/multiprocessing.html#programming-guidelines">Programming guidelines</a>: <em>Explicitly pass resources to child processes … On Unix a child process can make use of a shared resource created in a parent process using a global resource. However, it is better to pass the object as an argument to the constructor for the child process…</em></p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">s</span>
    
<span class="n">num_processes</span><span class="o">=</span><span class="mi">2</span>
<span class="k">with</span> <span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">num_processes</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">starmap</span><span class="p">(</span><span class="n">f</span><span class="p">,[(</span><span class="s1">&#39;hola&#39;</span><span class="p">,),(</span><span class="s1">&#39;mundo&#39;</span><span class="p">,)])</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;hola&#39;, &#39;mundo&#39;]
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id5">
<h3>Ejemplo regla compuesta del rectángulo<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">scipy.integrate</span> <span class="kn">import</span> <span class="n">quad</span>
<span class="kn">from</span> <span class="nn">pytest</span> <span class="kn">import</span> <span class="n">approx</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">math</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="n">a</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">b</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">n</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="mi">7</span>
<span class="n">h_hat</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">/</span><span class="n">n</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">p</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>
<span class="n">n_subintervals_per_subprocess</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="o">/</span><span class="n">p</span><span class="p">)</span> 
</pre></div>
</div>
</div>
</div>
<div class="admonition-comentario admonition">
<p class="admonition-title">Comentario</p>
<p><code class="docutils literal notranslate"><span class="pre">n_subintervals_per_subprocess</span></code> es el número de subintervalos por <em>core</em>. Se asume que <code class="docutils literal notranslate"><span class="pre">n</span></code> es divisible por <code class="docutils literal notranslate"><span class="pre">p</span></code>. Si no se cumple esto, se puede definir <code class="docutils literal notranslate"><span class="pre">n_subintervals_per_subprocess</span> <span class="pre">=</span> <span class="pre">int(n/p)</span></code> habiendo definido <code class="docutils literal notranslate"><span class="pre">n</span></code> primero y redefinir <code class="docutils literal notranslate"><span class="pre">n</span></code> como: <code class="docutils literal notranslate"><span class="pre">n</span> <span class="pre">=</span> <span class="pre">p*n_subintervals_per_subprocess</span></code></p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;número de subintervalos:&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>número de subintervalos: 10000000
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;número de subintervalos por proceso:&quot;</span><span class="p">,</span> <span class="n">n_subintervals_per_subprocess</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>número de subintervalos por proceso: 156250
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">Rcf_multiprocessing</span><span class="p">(</span><span class="n">my_id</span><span class="p">):</span>
    <span class="n">begin</span> <span class="o">=</span> <span class="n">my_id</span><span class="o">*</span><span class="n">n_subintervals_per_subprocess</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">begin</span><span class="o">+</span><span class="n">n_subintervals_per_subprocess</span>
    <span class="n">h_hat</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">/</span><span class="n">n</span>
    <span class="n">sum_res</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">begin</span><span class="p">,</span><span class="n">end</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">a</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">h_hat</span>
        <span class="n">sum_res</span> <span class="o">+=</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sum_res</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">start_time</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">res_map</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">Rcf_multiprocessing</span><span class="p">,</span><span class="nb">range</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
<span class="n">res_multiprocessing</span> <span class="o">=</span> <span class="n">h_hat</span><span class="o">*</span><span class="nb">sum</span><span class="p">(</span><span class="n">res_map</span><span class="p">)</span>
<span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">secs</span> <span class="o">=</span> <span class="n">end_time</span><span class="o">-</span><span class="n">start_time</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Rcf_multiprocessing tomó&quot;</span><span class="p">,</span><span class="n">secs</span><span class="p">,</span><span class="s2">&quot;segundos&quot;</span> <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Rcf_multiprocessing tomó 0.16410470008850098 segundos
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">obj</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="n">quad</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">res_multiprocessing</span> <span class="o">==</span> <span class="n">approx</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>it -n 5 -r 10 -o

<span class="n">res_map</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">Rcf_multiprocessing</span><span class="p">,</span><span class="nb">range</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
<span class="n">res_multiprocessing</span> <span class="o">=</span> <span class="n">h_hat</span><span class="o">*</span><span class="nb">sum</span><span class="p">(</span><span class="n">res_map</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>135 ms ± 6.22 ms per loop (mean ± std. dev. of 10 runs, 5 loops each)
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;TimeitResult : 135 ms ± 6.22 ms per loop (mean ± std. dev. of 10 runs, 5 loops each)&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Rcf_multiprocessing_timeit</span> <span class="o">=</span> <span class="n">_</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">Rcf_multiprocessing_timeit</span><span class="o">.</span><span class="n">average</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.1347037914800006
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="dask">
<h2><a class="reference external" href="https://github.com/dask/dask/">Dask</a><a class="headerlink" href="#dask" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Permite procesamiento en SMC o SMD.</p></li>
<li><p>Extiende interfaces de <em>arrays, dataframes</em> y listas usadas en <em>NumPy</em>, <em>Pandas</em> e <em>iterators</em> para su procesamiento. En el contexto de <em>Dask</em> a los tipos de valores anteriores les denomina <em>big data collections</em>.</p></li>
<li><p>Manejo de <em>datasets</em> que no caben en la memoria RAM: <em>larger than memory datasets</em> o <a class="reference external" href="https://en.wikipedia.org/wiki/External_memory_algorithm">out of core</a> <em>datasets</em>.</p></li>
<li><p>Las <em>big data collections</em> soportadas por <em>Dask</em> son alternativas a los <em>arrays</em> y <em>dataframes</em> de <em>NumPy</em> y <em>Pandas</em> respectivamente para <em>datasets</em> grandes.</p></li>
<li><p>Provee ejecución con cómputo paralelo o distribuido de <strong>algunas funciones</strong> de <em>NumPy</em> y <em>Pandas</em>.</p></li>
<li><p>Soporta un <em>task scheduling</em> dinámico y optimizado para cómputo.</p></li>
</ul>
<div class="admonition-comentarios admonition">
<p class="admonition-title">Comentarios</p>
<ul class="simple">
<li><p><em>Task scheduling</em> es un enfoque de paralelización en el que dividimos el programa en muchos <em>tasks medium-sized</em>. En <em>Dask</em> se representan tales <em>tasks</em> como nodos de un grafo con líneas entre éstos si un <em>task</em> depende de lo producido por otro.</p></li>
<li><p>Dinámico pues las <a class="reference external" href="https://docs.dask.org/en/latest/graphs.html">task graphs</a> pueden ser definidas a partir de las <em>big data collections</em> o por <em>users</em>.</p></li>
<li><p><em>Dask</em> posee módulos para optimizar la ejecución de las <em>task graphs</em> (más abajo se describe cómo construir una <em>task graph</em>). Ver <a class="reference external" href="https://docs.dask.org/en/latest/optimize.html">optimization</a>.</p></li>
</ul>
</div>
<ul class="simple">
<li><p>En <em>Dask</em> existen <a class="reference external" href="https://docs.dask.org/en/latest/scheduling.html">task schedulers</a> para ejecución en paralelo, distribuida o secuencial de la <em>task graph</em>.</p></li>
</ul>
<ul class="simple">
<li><p>Soporta el enfoque de paralelización de datos con las <em>collections</em>:</p>
<ul>
<li><p><a class="reference external" href="https://docs.dask.org/en/latest/array.html">dask arrays</a>,</p></li>
<li><p><a class="reference external" href="https://docs.dask.org/en/latest/dataframe.html">dask dataframes</a>,</p></li>
<li><p><a class="reference external" href="https://docs.dask.org/en/latest/bag.html">dask bags</a>.</p></li>
</ul>
</li>
</ul>
<div class="section" id="como-se-implementan-una-task-y-una-task-dask-graph-en-dask">
<h3>¿Cómo se implementan una <em>task</em> y una <em>task/dask graph</em> en <em>Dask</em>?<a class="headerlink" href="#como-se-implementan-una-task-y-una-task-dask-graph-en-dask" title="Permalink to this headline">¶</a></h3>
<p>Cada <em>task</em> se implementa como una tupla de <em>Python</em> que contiene funciones y argumentos de las mismas.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">fun_sum</span><span class="p">(</span><span class="n">arg1</span><span class="p">,</span><span class="n">arg2</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">arg1</span><span class="o">+</span><span class="n">arg2</span>

<span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">fun_sum</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(&lt;function fun_sum at 0x7fd2dfffa430&gt;, -1, 2)
</pre></div>
</div>
</div>
</div>
<p>Una <em>task graph</em> o <em>dask graph</em> se implementa como un diccionario de <em>tasks</em>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dic</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;arg1&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
       <span class="s2">&quot;arg2&quot;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
       <span class="s2">&quot;res&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">fun_sum</span><span class="p">,</span> <span class="s2">&quot;arg1&quot;</span><span class="p">,</span> <span class="s2">&quot;arg2&quot;</span><span class="p">)}</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="como-ejecutamos-la-task-dask-graph">
<h3>¿Cómo ejecutamos la <em>task/dask graph</em>?<a class="headerlink" href="#como-ejecutamos-la-task-dask-graph" title="Permalink to this headline">¶</a></h3>
<p>Con los <em>schedulers</em> definidos en <em>Dask</em>. Ver <a class="reference external" href="https://docs.dask.org/en/latest/scheduling.html">Scheduling</a> y <a class="reference external" href="https://docs.dask.org/en/latest/scheduler-overview.html">Scheduler Overview</a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">dask</span>
</pre></div>
</div>
</div>
</div>
<p>Para cualquier <em>scheduler</em> definido en dask el <em>entry point</em> es una función <em>get</em> la cual recibe una <em>task/dask graph</em> y una <em>key</em> o lista de <em>keys</em> para cálculos:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">dask</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dic</span><span class="p">,</span> <span class="s2">&quot;res&quot;</span><span class="p">))</span> <span class="c1">#synchronous scheduler </span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">dask</span><span class="o">.</span><span class="n">threaded</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dic</span><span class="p">,</span> <span class="s2">&quot;res&quot;</span><span class="p">))</span> <span class="c1">#scheduler backed by a thread pool</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">dask</span><span class="o">.</span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dic</span><span class="p">,</span> <span class="s2">&quot;res&quot;</span><span class="p">))</span> <span class="c1">#scheduler backed by a process pool</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1
</pre></div>
</div>
</div>
</div>
<div class="admonition-comentarios admonition">
<p class="admonition-title">Comentarios</p>
<ul class="simple">
<li><p>La función <code class="docutils literal notranslate"><span class="pre">dask.get</span></code> ejecuta con un <code class="docutils literal notranslate"><span class="pre">synchronous</span> <span class="pre">scheduler</span></code> el cual sólo utiliza un thread de ejecución sin paralelización. Útil para <em>debugging</em> y perfilamiento.</p></li>
<li><p>La función <code class="docutils literal notranslate"><span class="pre">dask.threaded.get</span></code> ejecuta con un <em>scheduler</em> <code class="docutils literal notranslate"><span class="pre">multiprocessing.pool.ThreadPool</span></code>. Se hacen <em>forks</em> y <em>joins</em> de un proceso. El <em>overhead</em> para ejecución es pequeño y no hay costo en transferencia de datos entre los <em>tasks</em>. Sin embargo debido al GIL de <em>Python</em>, este <em>scheduler</em> provee paralelización si tu código es esencialmente “no <em>Python</em>”, por ejemplo si utilizas código de <em>NumPy, Pandas</em> o <em>Cython</em>.</p></li>
<li><p>La función <code class="docutils literal notranslate"><span class="pre">dask.multiprocessing.get</span></code> ejecuta con un <em>scheduler</em> <code class="docutils literal notranslate"><span class="pre">multiprocessing.Pool</span></code>. Para cada <em>task</em> se crea un proceso, no tiene problemas del GIL de Python para código <em>Python</em>. Sin embargo, mover datos hacia procesos y de vuelta al proceso principal tiene costos altos. Útil para <em>tasks</em> que no requieren mucha transferencia de datos y los <em>inputs</em> y <em>outputs</em> son pequeños en tamaño.</p></li>
<li><p>En la documentación de <em>Dask</em> se recomienda utilizar al <em>scheduler distributed</em> en lugar de usar <code class="docutils literal notranslate"><span class="pre">dask.multiprocesing.get</span></code>. La documentación se encuentra en <a class="reference external" href="https://distributed.dask.org/en/latest/">Dask.distributed</a>. Para una pequeña explicación ver <a class="reference external" href="https://docs.dask.org/en/latest/scheduling.html#dask-distributed-local">Dask Distributed local</a>.</p></li>
</ul>
</div>
</div>
<div class="section" id="como-visualizamos-la-task-dask-graph">
<h3>¿Cómo visualizamos la <em>task/dask graph</em>?<a class="headerlink" href="#como-visualizamos-la-task-dask-graph" title="Permalink to this headline">¶</a></h3>
<p>Usamos <code class="docutils literal notranslate"><span class="pre">visualize</span></code>. Ver <a class="reference external" href="https://docs.dask.org/en/latest/graphviz.html">visualize task graphs</a> y <a class="reference external" href="https://docs.dask.org/en/latest/api.html#dask.visualize">dask.visualize</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dask</span><span class="o">.</span><span class="n">visualize</span><span class="p">(</span><span class="n">dic</span><span class="p">,</span><span class="s2">&quot;res&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/Computo_en_paralelo_usando_CPUS_en_SMC_158_0.png" src="../../_images/Computo_en_paralelo_usando_CPUS_en_SMC_158_0.png" />
</div>
</div>
<p>Las cajas representan datos, los círculos representan funciones que se ejecutan sobre tales datos y las flechas especifican cuáles funciones producen/consumen qué datos.</p>
</div>
<div class="section" id="flujo-de-trabajo-con-dask-collections">
<h3>Flujo de trabajo con <em>Dask collections</em><a class="headerlink" href="#flujo-de-trabajo-con-dask-collections" title="Permalink to this headline">¶</a></h3>
<p>En resumen en <em>Dask</em> seguimos un flujo como el siguiente dibujo.</p>
<img src="https://docs.dask.org/en/latest/_images/dask-overview.svg" heigth="400" width="400"><div class="tip admonition">
<p class="admonition-title">Observación</p>
<p>Para crear <em>task/dask graphs</em> podemos usar las <em>collections</em> o bien, definir nuestras propias.</p>
</div>
<div class="admonition-comentario admonition">
<p class="admonition-title">Comentario</p>
<p>Si trabajamos con las <em>collections</em> será extraño que trabajemos a nivel de funciones <code class="docutils literal notranslate"><span class="pre">get</span></code>. Cada <em>collection</em> tiene un default scheduler y una función <a class="reference external" href="https://docs.dask.org/en/latest/scheduler-overview.html#using-compute-methods">compute</a> que calcula el <em>output</em> de la <em>collection</em>.</p>
</div>
</div>
<div class="section" id="id6">
<h3>Ejemplo<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="https://docs.dask.org/en/latest/array.html">dask arrays</a> y <a class="reference external" href="https://docs.dask.org/en/latest/dataframe.html">dask dataframes</a> utilizan al <em>threaded scheduler</em> por <em>default</em> pero con <code class="docutils literal notranslate"><span class="pre">compute</span></code> puede cambiarse de <em>scheduler</em>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">dask.array</span> <span class="k">as</span> <span class="nn">da</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>dask.array&lt;arange, shape=(100,), dtype=int64, chunksize=(100,), chunktype=numpy.ndarray&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table>
<tr>
<td>
<table>
  <thead>
    <tr><td> </td><th> Array </th><th> Chunk </th></tr>
  </thead>
  <tbody>
    <tr><th> Bytes </th><td> 800 B </td> <td> 800 B </td></tr>
    <tr><th> Shape </th><td> (100,) </td> <td> (100,) </td></tr>
    <tr><th> Count </th><td> 1 Tasks </td><td> 1 Chunks </td></tr>
    <tr><th> Type </th><td> int64 </td><td> numpy.ndarray </td></tr>
  </tbody>
</table>
</td>
<td>
<svg width="170" height="75" style="stroke:rgb(0,0,0);stroke-width:1" >

  <!-- Horizontal lines -->
  <line x1="0" y1="0" x2="120" y2="0" style="stroke-width:2" />
  <line x1="0" y1="25" x2="120" y2="25" style="stroke-width:2" />

  <!-- Vertical lines -->
  <line x1="0" y1="0" x2="0" y2="25" style="stroke-width:2" />
  <line x1="120" y1="0" x2="120" y2="25" style="stroke-width:2" />

  <!-- Colored Rectangle -->
  <polygon points="0.0,0.0 120.0,0.0 120.0,25.412616514582485 0.0,25.412616514582485" style="fill:#ECB172A0;stroke-width:0"/>

  <!-- Text -->
  <text x="60.000000" y="45.412617" font-size="1.0rem" font-weight="100" text-anchor="middle" >100</text>
  <text x="140.000000" y="12.706308" font-size="1.0rem" font-weight="100" text-anchor="middle" transform="rotate(0,140.000000,12.706308)">1</text>
</svg>
</td>
</tr>
</table></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;class &#39;dask.array.core.Array&#39;&gt;
</pre></div>
</div>
</div>
</div>
<p>Llamamos a la función <a class="reference external" href="https://docs.dask.org/en/latest/api.html#dask.compute">dask.compute</a>.</p>
<div class="margin sidebar">
<p class="sidebar-title"></p>
<p>Por <em>default</em> el <em>dask array</em> utiliza el <em>threaded scheduler</em> para la ejecución de la <em>dask graph</em> asociada.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">compute</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4950
</pre></div>
</div>
</div>
</div>
<p>Podemos cambiar de <em>scheduler</em> especificando en <code class="docutils literal notranslate"><span class="pre">compute</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">scheduler</span><span class="o">=</span><span class="s2">&quot;processes&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4950
</pre></div>
</div>
</div>
</div>
<p>Por <em>default</em> <code class="docutils literal notranslate"><span class="pre">dask</span> <span class="pre">array</span></code> trabaja con <em>chunks</em>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table>
<tr>
<td>
<table>
  <thead>
    <tr><td> </td><th> Array </th><th> Chunk </th></tr>
  </thead>
  <tbody>
    <tr><th> Bytes </th><td> 800 B </td> <td> 80 B </td></tr>
    <tr><th> Shape </th><td> (100,) </td> <td> (10,) </td></tr>
    <tr><th> Count </th><td> 10 Tasks </td><td> 10 Chunks </td></tr>
    <tr><th> Type </th><td> int64 </td><td> numpy.ndarray </td></tr>
  </tbody>
</table>
</td>
<td>
<svg width="170" height="75" style="stroke:rgb(0,0,0);stroke-width:1" >

  <!-- Horizontal lines -->
  <line x1="0" y1="0" x2="120" y2="0" style="stroke-width:2" />
  <line x1="0" y1="25" x2="120" y2="25" style="stroke-width:2" />

  <!-- Vertical lines -->
  <line x1="0" y1="0" x2="0" y2="25" style="stroke-width:2" />
  <line x1="12" y1="0" x2="12" y2="25" />
  <line x1="24" y1="0" x2="24" y2="25" />
  <line x1="36" y1="0" x2="36" y2="25" />
  <line x1="48" y1="0" x2="48" y2="25" />
  <line x1="60" y1="0" x2="60" y2="25" />
  <line x1="72" y1="0" x2="72" y2="25" />
  <line x1="84" y1="0" x2="84" y2="25" />
  <line x1="96" y1="0" x2="96" y2="25" />
  <line x1="108" y1="0" x2="108" y2="25" />
  <line x1="120" y1="0" x2="120" y2="25" style="stroke-width:2" />

  <!-- Colored Rectangle -->
  <polygon points="0.0,0.0 120.0,0.0 120.0,25.412616514582485 0.0,25.412616514582485" style="fill:#ECB172A0;stroke-width:0"/>

  <!-- Text -->
  <text x="60.000000" y="45.412617" font-size="1.0rem" font-weight="100" text-anchor="middle" >100</text>
  <text x="140.000000" y="12.706308" font-size="1.0rem" font-weight="100" text-anchor="middle" transform="rotate(0,140.000000,12.706308)">1</text>
</svg>
</td>
</tr>
</table></div></div>
</div>
<p>Por <em>default</em>, <code class="docutils literal notranslate"><span class="pre">dask</span> <span class="pre">array</span></code> trabaja de una forma <em>lazy</em>, esto es, <code class="docutils literal notranslate"><span class="pre">dask</span> <span class="pre">array</span></code> no calculará ningún resultado hasta que explícitamente se le dé la instrucción.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table>
<tr>
<td>
<table>
  <thead>
    <tr><td> </td><th> Array </th><th> Chunk </th></tr>
  </thead>
  <tbody>
    <tr><th> Bytes </th><td> 8 B </td> <td> 8.0 B </td></tr>
    <tr><th> Shape </th><td> () </td> <td> () </td></tr>
    <tr><th> Count </th><td> 24 Tasks </td><td> 1 Chunks </td></tr>
    <tr><th> Type </th><td> int64 </td><td> numpy.ndarray </td></tr>
  </tbody>
</table>
</td>
<td>

</td>
</tr>
</table></div></div>
</div>
<p>Hasta este punto no se ha calculado la suma (cuyo resultado es un escalar). Después de llamar a <code class="docutils literal notranslate"><span class="pre">compute</span></code> se ejecuta la <em>task graph</em> para ejecución en paralelo (si se definió al <em>scheduler</em> para este tipo de ejecución).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">compute</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4950
</pre></div>
</div>
</div>
</div>
<p>Y podemos visualizar la <em>task/dask graph</em> definida en <code class="docutils literal notranslate"><span class="pre">y</span></code> que es un <em>dask array</em>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;class &#39;dask.array.core.Array&#39;&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y</span><span class="o">.</span><span class="n">visualize</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/Computo_en_paralelo_usando_CPUS_en_SMC_187_0.png" src="../../_images/Computo_en_paralelo_usando_CPUS_en_SMC_187_0.png" />
</div>
</div>
<p>Ver la API de <em>dask array</em> en <a class="reference external" href="https://docs.dask.org/en/latest/array-api.html">array api</a> para más funcionalidad.</p>
<div class="admonition-comentario admonition">
<p class="admonition-title">Comentario</p>
<p><em>Dask</em> tiene una función <a class="reference external" href="https://docs.dask.org/en/latest/scheduler-overview.html#the-compute-function">compute</a> más general que toma múltiples <em>collections</em> y regresa múltiples resultados. Esto combina grafos de cada <em>collection</em> de modo que resultados intermedios son compartidos.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">z</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">da</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(5050, 50.5)
</pre></div>
</div>
</div>
</div>
<p>y aquí el resultado intermedio <code class="docutils literal notranslate"><span class="pre">x+1</span></code> sólo fue calculado una vez. Si hubiéramos hecho:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">y</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
<span class="n">z</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>
</pre></div>
</div>
<p>el resultado intermedio <code class="docutils literal notranslate"><span class="pre">x+1</span></code> hubiera sido calculado dos veces. Ésta función <code class="docutils literal notranslate"><span class="pre">compute</span></code> trabaja sobre cualquier <em>collection</em> y se encuentra en <code class="docutils literal notranslate"><span class="pre">dask.base</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">dask.base</span> <span class="kn">import</span> <span class="n">compute</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">compute</span> <span class="ow">is</span> <span class="n">da</span><span class="o">.</span><span class="n">compute</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">compute</span><span class="p">(</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(5050, 50.5)
</pre></div>
</div>
</div>
</div>
<p>También se puede especificar para un <em>scheduler</em> <code class="docutils literal notranslate"><span class="pre">threaded</span></code> o <code class="docutils literal notranslate"><span class="pre">multiprocessing</span></code>, el número de <em>workers</em> en <code class="docutils literal notranslate"><span class="pre">compute</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">num_workers</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>5050
</pre></div>
</div>
</div>
</div>
<p>Ver <a class="reference external" href="https://docs.dask.org/en/latest/scheduling.html#configuration">configuration</a> para otras formas de especificar al <em>scheduler</em>. Ver también <a class="reference external" href="https://docs.dask.org/en/latest/delayed.html">Delayed</a> y <a class="reference external" href="https://examples.dask.org/delayed.html">Custom Workloads with Dask Delayed</a> para otra opción diferente a los <em>dask array</em>’s, <em>dask dataframe</em>’s y <em>dask bag</em>’s para cómputo <em>lazy</em>.</p>
</div>
<div class="section" id="dask-distributed">
<h3><a class="reference external" href="https://github.com/dask/distributed">Dask distributed</a><a class="headerlink" href="#dask-distributed" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Es un paquete que extiende a <a class="reference external" href="https://docs.python.org/3/library/concurrent.futures.html">concurrent.futures</a> (<code class="docutils literal notranslate"><span class="pre">multiprocessing</span></code> es similar a <code class="docutils literal notranslate"><span class="pre">concurrent.futures</span></code>) y a <em>Dask</em> para clústers de tamaño mediano (alrededor de cientos de máquinas).</p></li>
<li><p>Aunque el nombre <em>distributed</em> puede tomarse como que la ejecución sólo puede llevarse a cabo en clústers de máquinas, también puede utilizarse en nuestra máquina local.</p></li>
<li><p>Por razones como proveer acceso a una API asíncrona: <a class="reference external" href="https://docs.dask.org/en/latest/futures.html">Futures</a>, acceso a un <em>dashboard</em> diagnóstico y manejar mejor la <em>data locality</em> con múltiples procesos más eficientemente que con <code class="docutils literal notranslate"><span class="pre">dask.multiprocessing.get</span></code>, representa una <strong>alternativa fuerte</strong> a la generación de procesos locales vía <code class="docutils literal notranslate"><span class="pre">dask.multiprocessing</span></code>:  <em>The distributed scheduler described a couple sections below is often a better choice today than <code class="docutils literal notranslate"><span class="pre">dask.multiprocessing</span></code>…</em></p></li>
</ul>
<p>Tiene las siguientes características.</p>
<ul class="simple">
<li><p><em>Low latency: Each task suffers about 1ms of overhead. A small computation and network roundtrip can complete in less than 10ms.</em></p></li>
<li><p><em>Peer-to-peer data sharing: Workers communicate with each other to share data. This removes central bottlenecks for data transfer.</em></p></li>
<li><p><em>Complex Scheduling: Supports complex workflows (not just map/filter/reduce) which are necessary for sophisticated algorithms used in nd-arrays, machine learning, image processing, and statistics.</em></p></li>
<li><p><em>Data Locality: Scheduling algorithms cleverly execute computations where data lives. This minimizes network traffic and improves efficiency.</em></p></li>
<li><p><em>Familiar APIs: Compatible with the <a class="reference external" href="https://www.python.org/dev/peps/pep-3148/">concurrent.futures</a> API in the Python standard library. Compatible with dask API for parallel algorithms.</em></p></li>
</ul>
<p>Para ver más sobre el <em>distributed scheduler</em> ver <a class="reference external" href="https://distributed.dask.org/en/latest/#architecture">dask-architecture</a>.</p>
</div>
<div class="section" id="concurrent-futures">
<h3>¿<a class="reference external" href="https://docs.python.org/3/library/concurrent.futures.html">concurrent.futures</a>?<a class="headerlink" href="#concurrent-futures" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Es un paquete para ejecución de <em>tasks</em> en paralelo.</p></li>
<li><p>En <code class="docutils literal notranslate"><span class="pre">concurrent.futures</span></code> se trabaja con objetos de tipo valor <code class="docutils literal notranslate"><span class="pre">future</span></code> los cuales son resultados de cálculos que estarán disponibles en un futuro, de aquí el nombre de <em>future</em> y su cómputo <strong>no</strong> es <em>lazy</em> sino inmediato.</p></li>
<li><p>La obtención del <em>future</em> es asíncrona por lo que permite cómputo concurrente.</p></li>
</ul>
</div>
<div class="section" id="id7">
<h3>Ejemplo<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">inc</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span><span class="o">+</span><span class="mi">1</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Ejecución secuencial</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="n">inputs</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">]</span>
<span class="n">results</span><span class="o">=</span><span class="p">[]</span>

<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
    <span class="n">result</span><span class="o">=</span><span class="n">inc</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CPU times: user 949 µs, sys: 1.02 ms, total: 1.97 ms
Wall time: 10 s
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[2, 3, 4, 5, 6, 7, 8, 9, 10, 11]
</pre></div>
</div>
</div>
</div>
<p><strong>Ejecución con</strong> <code class="docutils literal notranslate"><span class="pre">concurrent.futures</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">concurrent.futures</span> <span class="kn">import</span> <span class="n">ProcessPoolExecutor</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">executor</span> <span class="o">=</span> <span class="n">ProcessPoolExecutor</span><span class="p">(</span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">executor</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;concurrent.futures.process.ProcessPoolExecutor object at 0x7fd2dece6ca0&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="n">future</span> <span class="o">=</span> <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">inc</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CPU times: user 39.7 ms, sys: 189 ms, total: 229 ms
Wall time: 218 ms
</pre></div>
</div>
</div>
</div>
<div class="tip admonition">
<p class="admonition-title">Observación</p>
<p>Obsérvese que se obtiene el <code class="docutils literal notranslate"><span class="pre">future</span></code> inmediatamente. Ver <a class="reference external" href="https://docs.python.org/3/library/concurrent.futures.html#concurrent.futures.Executor.submit">submit</a></p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">future</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Future at 0x7fd2df547af0 state=running&gt;
</pre></div>
</div>
</div>
</div>
<div class="tip admonition">
<p class="admonition-title">Observación</p>
<p>La ejecución del <code class="docutils literal notranslate"><span class="pre">future</span></code> se encuentra en algún subproceso del proceso principal. Obsérvese que tiene un estado <em>running</em>. Y después de un tiempo el estado ya es <em>finished</em>.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">future</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Future at 0x7fd2df547af0 state=running&gt;
</pre></div>
</div>
</div>
</div>
<p>Para obtener el resultado hacemos:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4
</pre></div>
</div>
</div>
</div>
<p>Entonces podemos hacer <code class="docutils literal notranslate"><span class="pre">submit</span></code> de varios cálculos de forma asíncrona con el objeto <code class="docutils literal notranslate"><span class="pre">executor</span></code> que devolverá <em>futures</em>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="n">inputs</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">]</span>
<span class="n">futures</span><span class="o">=</span><span class="p">[]</span>

<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">inputs</span><span class="p">:</span>
    <span class="n">future</span><span class="o">=</span><span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">inc</span><span class="p">,</span><span class="n">x</span><span class="p">)</span>
    <span class="n">futures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">future</span><span class="p">)</span>
    
<span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span> <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">futures</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CPU times: user 2.82 ms, sys: 3.09 ms, total: 5.92 ms
Wall time: 1.01 s
</pre></div>
</div>
</div>
</div>
<div class="admonition-comentario admonition">
<p class="admonition-title">Comentario</p>
<p>El <em>statement</em> <code class="docutils literal notranslate"><span class="pre">results</span> <span class="pre">=</span> <span class="pre">[future.result()</span> <span class="pre">for</span> <span class="pre">future</span> <span class="pre">in</span> <span class="pre">futures]</span></code> bloquea la ejecución del proceso local hasta que todos los procesos finalizan la ejecución.</p>
</div>
<div class="tip admonition">
<p class="admonition-title">Observación</p>
<p>Obsérvese que se redujo el tiempo pues la ejecución fue en paralelo por los subprocesos que ejecutaron <code class="docutils literal notranslate"><span class="pre">inc</span></code>.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[2, 3, 4, 5, 6, 7, 8, 9, 10, 11]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">executor</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="admonition-comentarios admonition">
<p class="admonition-title">Comentarios</p>
<ul class="simple">
<li><p>También en <code class="docutils literal notranslate"><span class="pre">concurrent.futures</span></code> se tiene una función <a class="reference external" href="https://docs.python.org/3/library/concurrent.futures.html#concurrent.futures.Executor.map">map</a> para cómputo inmediato (no <em>lazy</em>) usando <em>futures</em> que soporta múltiples llamados a una función utilizando un <em>iterable</em>.</p></li>
<li><p>Para una vista rápida a <code class="docutils literal notranslate"><span class="pre">concurrent.futures</span></code> ver: <a class="reference external" href="http://masnun.com/2016/03/29/python-a-quick-introduction-to-the-concurrent-futures-module.html">Python: A quick introduction to the concurrent.futures module</a>.</p></li>
</ul>
</div>
</div>
<div class="section" id="client-de-dask-distributed">
<h3><em>Client</em> de <code class="docutils literal notranslate"><span class="pre">dask.distributed</span></code><a class="headerlink" href="#client-de-dask-distributed" title="Permalink to this headline">¶</a></h3>
<p>El <a class="reference external" href="https://distributed.dask.org/en/latest/client.html">Client</a> es el <em>entry point</em> para users de <code class="docutils literal notranslate"><span class="pre">dask.distributed</span></code>. Creamos un <em>distributed scheduler</em> al importar <code class="docutils literal notranslate"><span class="pre">Client</span></code>. Esta acción <em>override</em> cualquier configuración que se haya hecho del <em>scheduler</em>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">dask.distributed</span> <span class="kn">import</span> <span class="n">Client</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="admonition-comentario admonition">
<p class="admonition-title">Comentario</p>
<p>Al <code class="docutils literal notranslate"><span class="pre">Client</span></code> se le pueden pasar argumentos como número de <em>workers</em>, si se desean procesos o no, el límite de memoria a usar por cada proceso, entre otros.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;Client: &#39;tcp://127.0.0.1:45025&#39; processes=8 threads=64, memory=251.89 GiB&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">client</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table style="border: 2px solid white;">
<tr>
<td style="vertical-align: top; border: 0px solid white">
<h3 style="text-align: left;">Client</h3>
<ul style="text-align: left; list-style: none; margin: 0; padding: 0;">
  <li><b>Scheduler: </b>tcp://127.0.0.1:45025</li>
  <li><b>Dashboard: </b><a href='http://127.0.0.1:8787/status' target='_blank'>http://127.0.0.1:8787/status</a></li>
</ul>
</td>
<td style="vertical-align: top; border: 0px solid white">
<h3 style="text-align: left;">Cluster</h3>
<ul style="text-align: left; list-style:none; margin: 0; padding: 0;">
  <li><b>Workers: </b>8</li>
  <li><b>Cores: </b>64</li>
  <li><b>Memory: </b>251.89 GiB</li>
</ul>
</td>
</tr>
</table></div></div>
</div>
<p>Para ir al <em>dashboard</em> que se expone con <a class="reference external" href="https://docs.bokeh.org/en/latest/index.html">bokeh</a> ir a la url con puerto <code class="docutils literal notranslate"><span class="pre">8787</span></code>.</p>
<div class="tip admonition">
<p class="admonition-title">Observación</p>
<p>Si se ejecuta con una imagen de <em>Docker</em>, revisar a qué puerto está mapeado el <code class="docutils literal notranslate"><span class="pre">8787</span></code>.</p>
</div>
<img src="https://dl.dropboxusercontent.com/s/n5i7r4tp0saffmx/dask_1.png?dl=0" heigth="500" width="500"><p>y en el apartado de <code class="docutils literal notranslate"><span class="pre">workers</span></code>:</p>
<img src="https://dl.dropboxusercontent.com/s/aqspobw9mmtw1tw/dask_2.png?dl=0" heigth="500" width="500"><p>Ver <a class="reference external" href="http://distributed.dask.org/en/1.12.2/web.html">Web Interface</a> y <a class="reference external" href="https://distributed.dask.org/en/latest/diagnosing-performance.html">Diagnosing Performance</a> para más sobre la información de diagnóstico que se junta en el dashboard.</p>
<div class="admonition-comentarios admonition">
<p class="admonition-title">Comentarios</p>
<ul class="simple">
<li><p>La línea anterior que contiene <code class="docutils literal notranslate"><span class="pre">Client</span></code>, configura un <em>scheduler</em> en el proceso local y varios procesos <em>workers</em> o <em>dask-workers</em> que corren un <em>thread</em> de ejecución (pueden correr más por <em>default</em>). Si se desea que los procesos <em>worker</em> estén contenidos en el proceso local puede usarse <code class="docutils literal notranslate"><span class="pre">Client(processes=False)</span></code>. Esta situación es preferible si se desea evitar comunicación <em>inter worker</em> y si nuestros cálculos están soltando el <em>GIL</em> (por ejemplo al usar <em>NumPy</em> o <code class="docutils literal notranslate"><span class="pre">dask.array</span></code>).</p></li>
<li><p>Algunas opciones que pueden utilizarse con la línea de <code class="docutils literal notranslate"><span class="pre">Client</span></code> son:</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Client(n_workers=4)</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Client(threads_per_worker=2)</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Client(memory_limit='10GB')</span></code>.</p></li>
</ul>
<p>Ver <a class="reference external" href="https://docs.dask.org/en/latest/setup/single-distributed.html#distributed.deploy.local.LocalCluster">LocalCluster</a> para opciones a usar en <code class="docutils literal notranslate"><span class="pre">Client</span></code> y <a class="reference external" href="https://distributed.dask.org/en/latest/api.html">API</a> para la API con <code class="docutils literal notranslate"><span class="pre">Client</span></code>.</p>
</div>
</div>
<div class="section" id="ejemplo-regla-compuesta-del-rectangulo-con-map-y-gather">
<h3>Ejemplo regla compuesta del rectángulo con <code class="docutils literal notranslate"><span class="pre">map</span></code> y <code class="docutils literal notranslate"><span class="pre">gather</span></code><a class="headerlink" href="#ejemplo-regla-compuesta-del-rectangulo-con-map-y-gather" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">create_nodes_in_subintervals</span><span class="p">(</span><span class="n">my_id</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">h_hat</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">n_s_sub</span><span class="p">):</span>
    <span class="n">begin</span> <span class="o">=</span> <span class="n">my_id</span><span class="o">*</span><span class="n">n_s_sub</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">begin</span><span class="o">+</span><span class="n">n_s_sub</span>
    <span class="n">h_hat</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">/</span><span class="n">n</span>
    <span class="n">nodes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">begin</span><span class="p">,</span><span class="n">end</span><span class="p">):</span>
        <span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span><span class="o">*</span><span class="n">h_hat</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">nodes</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">evaluate_f_in_nodes_and_sum</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span><span class="n">f</span><span class="p">):</span>
    <span class="n">sum_res</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
        <span class="n">sum_res</span><span class="o">+=</span><span class="n">f</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sum_res</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="n">futures_nodes</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">create_nodes_in_subintervals</span><span class="p">,</span><span class="nb">range</span><span class="p">(</span><span class="n">p</span><span class="p">),</span>
                           <span class="o">**</span><span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span><span class="n">a</span><span class="p">,</span>
                              <span class="s1">&#39;b&#39;</span><span class="p">:</span><span class="n">b</span><span class="p">,</span>
                              <span class="s2">&quot;h_hat&quot;</span><span class="p">:</span><span class="n">h_hat</span><span class="p">,</span>
                              <span class="s1">&#39;n&#39;</span><span class="p">:</span><span class="n">n</span><span class="p">,</span>
                              <span class="s2">&quot;n_s_sub&quot;</span><span class="p">:</span><span class="n">n_subintervals_per_subprocess</span><span class="p">}</span>
                            <span class="p">)</span>
<span class="n">futures_evaluated</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">evaluate_f_in_nodes_and_sum</span><span class="p">,</span> <span class="n">futures_nodes</span><span class="p">,</span>
                            <span class="o">**</span><span class="p">{</span><span class="s1">&#39;f&#39;</span><span class="p">:</span><span class="n">f</span><span class="p">}</span>
                            <span class="p">)</span>
<span class="n">results_gather</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">futures_evaluated</span><span class="p">)</span>
<span class="n">res_rcf_distributed</span> <span class="o">=</span> <span class="n">h_hat</span><span class="o">*</span><span class="nb">sum</span><span class="p">(</span><span class="n">results_gather</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CPU times: user 110 ms, sys: 55.8 ms, total: 166 ms
Wall time: 1 s
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">res_rcf_distributed</span> <span class="o">==</span> <span class="n">approx</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="admonition-comentarios admonition">
<p class="admonition-title">Comentarios</p>
<ul class="simple">
<li><p>Con <code class="docutils literal notranslate"><span class="pre">map</span></code> o <code class="docutils literal notranslate"><span class="pre">submit</span></code> se han enviado las <em>tasks</em> al <em>scheduler</em> a realizar. Ver <a class="reference external" href="https://distributed.dask.org/en/latest/api.html">map</a>, <a class="reference external" href="https://distributed.dask.org/en/latest/api.html#distributed.Client.submit">submit</a> y <a class="reference external" href="https://distributed.dask.org/en/latest/client.html#concurrent-futures">concurrent.futures</a>.</p></li>
<li><p>Las ejecuciones <code class="docutils literal notranslate"><span class="pre">map</span></code> son muy rápidas e inmediatas pues se regresan <em>futures</em>.</p></li>
<li><p>Los cálculos definidos por las funciones <code class="docutils literal notranslate"><span class="pre">create_nodes_in_subintervals</span></code> y <code class="docutils literal notranslate"><span class="pre">evaluate_f_in_nodes_and_sum</span></code> se ejecutan en cada <em>dask-worker</em> y a distintos tiempos.</p></li>
<li><p>Obsérvese que se puede hacer <code class="docutils literal notranslate"><span class="pre">map</span></code> o <code class="docutils literal notranslate"><span class="pre">submit</span></code> en <em>futures</em>.</p></li>
<li><p>Los resultados viven en los procesos <em>dask-workers</em>.</p></li>
<li><p>Con <code class="docutils literal notranslate"><span class="pre">gather</span></code> se juntan los resultados (<em>futures</em>) en el proceso local.</p></li>
<li><p>Podemos usar <code class="docutils literal notranslate"><span class="pre">gather</span></code> o <code class="docutils literal notranslate"><span class="pre">result</span></code> de los <em>futures</em>.</p></li>
</ul>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="ejemplo-regla-compuesta-del-rectangulo-con-map-y-result">
<h3>Ejemplo regla compuesta del rectángulo con <code class="docutils literal notranslate"><span class="pre">map</span></code> y <code class="docutils literal notranslate"><span class="pre">result</span></code><a class="headerlink" href="#ejemplo-regla-compuesta-del-rectangulo-con-map-y-result" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">n_workers</span><span class="o">=</span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">(),</span>
                <span class="n">threads_per_worker</span><span class="o">=</span><span class="mi">1</span>
               <span class="p">)</span>  
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">client</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table style="border: 2px solid white;">
<tr>
<td style="vertical-align: top; border: 0px solid white">
<h3 style="text-align: left;">Client</h3>
<ul style="text-align: left; list-style: none; margin: 0; padding: 0;">
  <li><b>Scheduler: </b>tcp://127.0.0.1:35749</li>
  <li><b>Dashboard: </b><a href='http://127.0.0.1:8787/status' target='_blank'>http://127.0.0.1:8787/status</a></li>
</ul>
</td>
<td style="vertical-align: top; border: 0px solid white">
<h3 style="text-align: left;">Cluster</h3>
<ul style="text-align: left; list-style:none; margin: 0; padding: 0;">
  <li><b>Workers: </b>64</li>
  <li><b>Cores: </b>64</li>
  <li><b>Memory: </b>251.89 GiB</li>
</ul>
</td>
</tr>
</table></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%time</span>
<span class="n">futures_nodes</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">create_nodes_in_subintervals</span><span class="p">,</span><span class="nb">range</span><span class="p">(</span><span class="n">p</span><span class="p">),</span>
                           <span class="o">**</span><span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span><span class="n">a</span><span class="p">,</span>
                              <span class="s1">&#39;b&#39;</span><span class="p">:</span><span class="n">b</span><span class="p">,</span>
                              <span class="s2">&quot;h_hat&quot;</span><span class="p">:</span><span class="n">h_hat</span><span class="p">,</span>
                              <span class="s1">&#39;n&#39;</span><span class="p">:</span><span class="n">n</span><span class="p">,</span>
                              <span class="s2">&quot;n_s_sub&quot;</span><span class="p">:</span><span class="n">n_subintervals_per_subprocess</span><span class="p">}</span>
                            <span class="p">)</span>
<span class="n">futures_evaluated</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">evaluate_f_in_nodes_and_sum</span><span class="p">,</span> <span class="n">futures_nodes</span><span class="p">,</span>
                                                       <span class="o">**</span><span class="p">{</span><span class="s1">&#39;f&#39;</span><span class="p">:</span><span class="n">f</span><span class="p">}</span>
                            <span class="p">)</span>

<span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span> <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">futures_evaluated</span><span class="p">]</span>
<span class="n">res_rcf_distributed</span> <span class="o">=</span> <span class="n">h_hat</span><span class="o">*</span><span class="nb">sum</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CPU times: user 428 ms, sys: 75.4 ms, total: 503 ms
Wall time: 630 ms
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">res_rcf_distributed</span> <span class="o">==</span> <span class="n">approx</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="grafica-de-tiempo-de-ejecucion-vs-numero-de-procesos">
<h3>Gráfica de tiempo de ejecución vs número de procesos<a class="headerlink" href="#grafica-de-tiempo-de-ejecucion-vs-numero-de-procesos" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">err_np</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">n_cpus</span> <span class="o">=</span> <span class="p">[]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">relative_error</span><span class="p">(</span><span class="n">aprox</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">aprox</span><span class="o">-</span><span class="n">obj</span><span class="p">)</span><span class="o">/</span><span class="n">math</span><span class="o">.</span><span class="n">fabs</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">Rcf_dask</span><span class="p">(</span><span class="n">my_id</span><span class="p">,</span><span class="n">f</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">h_hat</span><span class="p">,</span><span class="n">n</span><span class="p">,</span><span class="n">n_s_sub</span><span class="p">):</span>
    <span class="n">begin</span><span class="o">=</span><span class="n">my_id</span><span class="o">*</span><span class="n">n_s_sub</span>
    <span class="n">end</span><span class="o">=</span><span class="n">begin</span><span class="o">+</span><span class="n">n_s_sub</span>
    <span class="n">h_hat</span><span class="o">=</span><span class="p">(</span><span class="n">b</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">/</span><span class="n">n</span>
    <span class="n">sum_res</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">begin</span><span class="p">,</span><span class="n">end</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">a</span><span class="o">+</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">h_hat</span>
        <span class="n">sum_res</span> <span class="o">+=</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sum_res</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">myfun</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">n_s_sub</span><span class="p">):</span>
    <span class="n">futures_Rcf_dask</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">Rcf_dask</span><span class="p">,</span><span class="nb">range</span><span class="p">(</span><span class="n">p</span><span class="p">),</span>
                              <span class="o">**</span><span class="p">{</span><span class="s1">&#39;f&#39;</span><span class="p">:</span><span class="n">f</span><span class="p">,</span>
                                 <span class="s1">&#39;a&#39;</span><span class="p">:</span><span class="n">a</span><span class="p">,</span>
                                 <span class="s1">&#39;b&#39;</span><span class="p">:</span><span class="n">b</span><span class="p">,</span>
                                 <span class="s2">&quot;h_hat&quot;</span><span class="p">:</span><span class="n">h_hat</span><span class="p">,</span>
                                 <span class="s1">&#39;n&#39;</span><span class="p">:</span><span class="n">n</span><span class="p">,</span>
                                 <span class="s2">&quot;n_s_sub&quot;</span><span class="p">:</span><span class="n">n_s_sub</span><span class="p">}</span>
                              <span class="p">)</span> 
    <span class="n">results_gather</span> <span class="o">=</span> <span class="n">cl</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">futures_Rcf_dask</span><span class="p">)</span>
    <span class="n">res_rcf_dask</span> <span class="o">=</span> <span class="n">h_hat</span><span class="o">*</span><span class="nb">sum</span><span class="p">(</span><span class="n">results_gather</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">relative_error</span><span class="p">(</span><span class="n">res_rcf_dask</span><span class="p">,</span><span class="n">obj</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="margin sidebar">
<p class="sidebar-title"></p>
<p>Ejecutamos <code class="docutils literal notranslate"><span class="pre">close</span></code> para las creaciones de clientes anteriores.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">client</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table style="border: 2px solid white;">
<tr>
<td style="vertical-align: top; border: 0px solid white">
<h3 style="text-align: left;">Client</h3>
<ul style="text-align: left; list-style: none; margin: 0; padding: 0;">
  <li><b>Scheduler: </b>tcp://127.0.0.1:35749</li>
  <li><b>Dashboard: </b><a href='http://127.0.0.1:8787/status' target='_blank'>http://127.0.0.1:8787/status</a></li>
</ul>
</td>
<td style="vertical-align: top; border: 0px solid white">
<h3 style="text-align: left;">Cluster</h3>
<ul style="text-align: left; list-style:none; margin: 0; padding: 0;">
  <li><b>Workers: </b>0</li>
  <li><b>Cores: </b>0</li>
  <li><b>Memory: </b>0 B</li>
</ul>
</td>
</tr>
</table></div></div>
</div>
<p><strong>Primero revisamos errores relativos</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">n</span><span class="o">%</span><span class="k">p</span>==0:
        <span class="n">n_subintervals_per_subprocess</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="o">/</span><span class="n">p</span><span class="p">)</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">n_workers</span><span class="o">=</span><span class="n">p</span><span class="p">,</span>
                        <span class="n">threads_per_worker</span><span class="o">=</span><span class="mi">1</span>
                       <span class="p">)</span>
        <span class="n">err_np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">myfun</span><span class="p">(</span><span class="n">client</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">n_subintervals_per_subprocess</span><span class="p">))</span>
        <span class="n">n_cpus</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">err_np</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[4.99495021497577e-14, 1.4419945561090765e-14, 2.4231454911936028e-14, 5.886905610507158e-14, 1.3825308630736507e-14, 1.7690448678039188e-14, 3.716480814714115e-15, 3.86514004730268e-15, 2.527206954005598e-15, 2.973184651771292e-15, 2.229888488828469e-15, 2.6758661865941626e-15, 1.486592325885646e-15]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">n_cpus</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1, 2, 4, 5, 8, 10, 16, 20, 25, 32, 40, 50, 64]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">l</span><span class="o">=</span><span class="p">[]</span>
<span class="n">n_cpus</span><span class="o">=</span><span class="p">[]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">client</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table style="border: 2px solid white;">
<tr>
<td style="vertical-align: top; border: 0px solid white">
<h3 style="text-align: left;">Client</h3>
<ul style="text-align: left; list-style: none; margin: 0; padding: 0;">
  <li><b>Scheduler: </b>tcp://127.0.0.1:36511</li>
  <li><b>Dashboard: </b><a href='http://127.0.0.1:8787/status' target='_blank'>http://127.0.0.1:8787/status</a></li>
</ul>
</td>
<td style="vertical-align: top; border: 0px solid white">
<h3 style="text-align: left;">Cluster</h3>
<ul style="text-align: left; list-style:none; margin: 0; padding: 0;">
  <li><b>Workers: </b>0</li>
  <li><b>Cores: </b>0</li>
  <li><b>Memory: </b>0 B</li>
</ul>
</td>
</tr>
</table></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">n</span><span class="o">%</span><span class="k">p</span>==0:
        <span class="n">n_subintervals_per_subprocess</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="o">/</span><span class="n">p</span><span class="p">)</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">n_workers</span><span class="o">=</span><span class="n">p</span><span class="p">,</span>
                <span class="n">threads_per_worker</span><span class="o">=</span><span class="mi">1</span>
                       <span class="p">)</span>
        <span class="n">start_time</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">futures_Rcf_dask</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">Rcf_dask</span><span class="p">,</span><span class="nb">range</span><span class="p">(</span><span class="n">p</span><span class="p">),</span>
                                      <span class="o">**</span><span class="p">{</span><span class="s1">&#39;f&#39;</span><span class="p">:</span><span class="n">f</span><span class="p">,</span>
                                         <span class="s1">&#39;a&#39;</span><span class="p">:</span><span class="n">a</span><span class="p">,</span>
                                         <span class="s1">&#39;b&#39;</span><span class="p">:</span><span class="n">b</span><span class="p">,</span>
                                         <span class="s2">&quot;h_hat&quot;</span><span class="p">:</span><span class="n">h_hat</span><span class="p">,</span>
                                         <span class="s1">&#39;n&#39;</span><span class="p">:</span><span class="n">n</span><span class="p">,</span>
                                         <span class="s2">&quot;n_s_sub&quot;</span><span class="p">:</span><span class="n">n_subintervals_per_subprocess</span><span class="p">}</span>
                                     <span class="p">)</span>
        <span class="n">res_gather</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">futures_Rcf_dask</span><span class="p">)</span>
        <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">secs</span> <span class="o">=</span> <span class="n">end_time</span><span class="o">-</span><span class="n">start_time</span>
        <span class="n">l</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">secs</span><span class="p">)</span>
        <span class="n">n_cpus</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">client</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[3.701357364654541, 1.8432807922363281, 0.9091541767120361, 0.7361886501312256, 0.4691917896270752, 0.4330434799194336, 0.26079630851745605, 0.23067212104797363, 0.2382211685180664, 0.3052539825439453, 0.2685668468475342, 0.2464737892150879, 0.2692685127258301]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">n_cpus</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1, 2, 4, 5, 8, 10, 16, 20, 25, 32, 40, 50, 64]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">n_cpus</span><span class="p">,</span><span class="n">l</span><span class="p">,</span><span class="s1">&#39;o-&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Gráfica num cpus vs tiempo&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;num cpus&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;tiempo&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/Computo_en_paralelo_usando_CPUS_en_SMC_274_0.png" src="../../_images/Computo_en_paralelo_usando_CPUS_en_SMC_274_0.png" />
</div>
</div>
</div>
<div class="section" id="ejemplo-regla-compuesta-del-rectangulo-con-dask-array">
<h3>Ejemplo regla compuesta del rectángulo con <code class="docutils literal notranslate"><span class="pre">dask.array</span></code><a class="headerlink" href="#ejemplo-regla-compuesta-del-rectangulo-con-dask-array" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f_np</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">Rcf_dask_array</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">n</span><span class="p">,</span> <span class="n">n_s_w</span><span class="p">,</span> <span class="n">n_workers</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute numerical approximation using rectangle or mid-point</span>
<span class="sd">    method in an interval.</span>
<span class="sd">    Nodes are generated via formula: x_i = a+(i+1/2)h_hat for</span>
<span class="sd">    i=0,1,...,n-1 and h_hat=(b-a)/n</span>
<span class="sd">    Args:</span>
<span class="sd">    </span>
<span class="sd">        f (float): function expression of integrand.</span>
<span class="sd">        </span>
<span class="sd">        a (float): left point of interval.</span>
<span class="sd">        </span>
<span class="sd">        b (float): right point of interval.</span>
<span class="sd">        </span>
<span class="sd">        n (int): number of subintervals.</span>
<span class="sd">        </span>
<span class="sd">        n_s_w (int): number of subintervals per worker</span>
<span class="sd">        </span>
<span class="sd">        n_workers (int): number of workers</span>
<span class="sd">        </span>
<span class="sd">    Returns:</span>
<span class="sd">    </span>
<span class="sd">        sum_res (float): numerical approximation to integral</span>
<span class="sd">            of f in the interval a,b</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">h_hat</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">/</span><span class="n">n</span>
    <span class="n">aux_dask_array</span> <span class="o">=</span> <span class="n">da</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">chunks</span> <span class="o">=</span> <span class="n">n_s_w</span><span class="p">)</span>
    <span class="n">nodes</span> <span class="o">=</span> <span class="p">(</span><span class="n">aux_dask_array</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">aux_dask_array</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">f_evaluated_in_nodes</span> <span class="o">=</span> <span class="n">f_np</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span>
    <span class="n">res_sum</span> <span class="o">=</span> <span class="n">f_evaluated_in_nodes</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">compute</span><span class="p">(</span><span class="n">num_workers</span><span class="o">=</span><span class="n">n_workers</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">h_hat</span><span class="o">*</span><span class="n">res_sum</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">n_subintervals_per_subprocess</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>64 156250
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">start_time</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">res_rcf_dask_array</span> <span class="o">=</span> <span class="n">Rcf_dask_array</span><span class="p">(</span><span class="n">f_np</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">n</span><span class="p">,</span> 
                                    <span class="n">n_subintervals_per_subprocess</span><span class="p">,</span> 
                                    <span class="n">p</span><span class="p">)</span>
<span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">secs</span> <span class="o">=</span> <span class="n">end_time</span><span class="o">-</span><span class="n">start_time</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Rcf_dask_array tomó&quot;</span><span class="p">,</span><span class="n">secs</span><span class="p">,</span><span class="s2">&quot;segundos&quot;</span> <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Rcf_dask_array tomó 0.1601552963256836 segundos
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">res_rcf_dask_array</span> <span class="o">==</span> <span class="n">approx</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<div class="tip admonition">
<p class="admonition-title">Ejercicio</p>
<p>Implementar la regla de Simpson compuesta con <em>Multiprocessing</em> y <em>Dask</em> en una máquina de AWS con las mismas características que la que se presenta en esta nota, medir tiempo de ejecución y realizar gráfica de tiempo vs num cpus.</p>
</div>
</div>
</div>
<div class="section" id="parallel">
<h2><a class="reference external" href="https://www.rdocumentation.org/packages/parallel/versions/3.6.2">Parallel</a><a class="headerlink" href="#parallel" title="Permalink to this headline">¶</a></h2>
<p>Entre las herramientas más populares en <em>R</em> para cómputo en paralelo se encuentran:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://www.rdocumentation.org/packages/snow/versions/0.4-3">Simple Network Of Workstations: snow</a>. Ya es una herramienta incluida en el paquete <em>Parallel</em>). Ver <a class="reference external" href="http://homepage.divms.uiowa.edu/~luke/R/cluster/cluster.html">liga</a> para más información.</p></li>
<li><p><a class="reference external" href="https://www.rdocumentation.org/packages/future/versions/1.15.1/topics/multicore">multicore</a>. Funciona en la familia Unix pero no en Windows y ya es una herramienta incluida en el paquete <em>Parallel</em>.</p></li>
<li><p><a class="reference external" href="https://www.rdocumentation.org/packages/foreach/versions/1.4.7/topics/foreach">foreach</a>. Hay ventajas al usarse con el paquete <a class="reference external" href="https://www.rdocumentation.org/packages/iterators/versions/1.0.12">iterators</a>.</p></li>
<li><p><a class="reference external" href="https://www.rdocumentation.org/packages/Rmpi/versions/0.6-9">Rmpi</a>. Paralelización en SMC y en SMD.</p></li>
</ul>
<div class="admonition-comentarios admonition">
<p class="admonition-title">Comentarios</p>
<ul class="simple">
<li><p>Las primeras dos son parte del paquete <a class="reference external" href="https://www.rdocumentation.org/packages/parallel/versions/3.6.2">parallel</a> el cual está incluido en la instalación de <em>R</em> desde la versión <code class="docutils literal notranslate"><span class="pre">2.14.0</span></code>.</p></li>
<li><p>Los cuatro paquetes de arriba emplean un paradigma de programación en paralelo del tipo <em>scatter/gather</em>: se tienen múltiples instancias de <em>R</em> corriendo al mismo tiempo en un clúster de máquinas o en una máquina <em>multicore</em>. Una de las instancias se le denomina <em>manager</em>  y las restantes <em>workers</em>. El cómputo en paralelo procede como sigue:</p>
<ul>
<li><p><strong>scatter</strong>: <em>manager</em> descompone el cómputo a realizar en <em>chunks</em> y envía (<em>scatters</em>) los <em>chunks</em> a <em>workers</em>.</p></li>
<li><p><strong>chunk computation</strong>: <em>workers</em> hacen el cómputo en cada <em>chunk</em> y envían de regreso los resultados a <em>manager</em>.</p></li>
<li><p><strong>gather</strong>: <em>manager</em> recibe (<em>gathers</em>) los resultados y los combina para resolver el problema.</p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="id8">
<h3>Ejemplo<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">library</span><span class="p">(</span><span class="n">parallel</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>En <em>Parallel</em> tenemos la función <code class="docutils literal notranslate"><span class="pre">detectCores</span></code> que como su nombre lo indica obtiene el número de CPU’s en nuestra máquina.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">p</span> <span class="o">&lt;-</span> <span class="n">detectCores</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">p</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">64</div></div>
</div>
<p>Usamos <code class="docutils literal notranslate"><span class="pre">makeCluster</span></code> para iniciar el <em>snow cluster</em>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cl</span> <span class="o">&lt;-</span> <span class="n">makeCluster</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>La línea anterior crea <code class="docutils literal notranslate"><span class="pre">p</span></code> <em>workers</em> y cada <em>worker</em> es un proceso de <em>R</em> (al igual que el proceso <em>manager</em>) que corren en la misma máquina.</p>
<div class="admonition-comentario admonition">
<p class="admonition-title">Comentario</p>
<p>El nombre de clúster en <em>snow</em> hace referencia al conjunto de <em>workers</em> y no a máquinas físicas. El objeto <code class="docutils literal notranslate"><span class="pre">cl</span></code> contiene información de <em>workers</em> y es de clase <code class="docutils literal notranslate"><span class="pre">cluster</span></code>.</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">class</span><span class="p">(</span><span class="n">cl</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1] &quot;SOCKcluster&quot; &quot;cluster&quot;    
</pre></div>
</div>
</div>
</div>
<p>La comunicación entre <em>manager</em> y <em>workers</em> por <em>default</em> en <code class="docutils literal notranslate"><span class="pre">makeCluster</span></code> es vía <a class="reference external" href="https://en.wikipedia.org/wiki/Network_socket">network sockets</a> y es posible crear un clúster de máquinas físicas conectadas vía una network.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">cl</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>socket cluster with 64 nodes on host ‘localhost’
</pre></div>
</div>
</div>
</div>
<div class="section" id="clusterapply">
<h4>clusterApply<a class="headerlink" href="#clusterapply" title="Permalink to this headline">¶</a></h4>
<p>En <em>Parallel</em> se tiene la función <a class="reference external" href="https://www.rdocumentation.org/packages/parallel/versions/3.6.2/topics/clusterApply">clusterApply</a> para ejecución en paralelo de una función aplicada a cada elemento de una lista: <em>manager</em> envía <code class="docutils literal notranslate"><span class="pre">lista[1]</span></code> a <code class="docutils literal notranslate"><span class="pre">cl[1]</span></code>, <code class="docutils literal notranslate"><span class="pre">lista[2]</span></code> a <code class="docutils literal notranslate"><span class="pre">cl[2]</span></code>,…,<code class="docutils literal notranslate"><span class="pre">lista[p]</span></code> a <code class="docutils literal notranslate"><span class="pre">cl[p]</span></code>.</p>
<p>Además, si el número de elementos de la lista es mayor que el número de <em>workers</em> entonces <code class="docutils literal notranslate"><span class="pre">clusterApply</span></code> realiza una asignación tipo <em>round robin</em>: por ejemplo, si la lista tiene <span class="math notranslate nohighlight">\(4\)</span> elementos y se tienen <span class="math notranslate nohighlight">\(2\)</span> <em>workers</em> entonces <code class="docutils literal notranslate"><span class="pre">clusterApply</span></code> le envía a <em>worker1</em> el elemento de la primera posición de la lista, a <em>worker2</em> el segundo elemento. Después que <em>worker1</em> finaliza el procesamiento, <code class="docutils literal notranslate"><span class="pre">clusterApply</span></code> le envía la tercera posición y al terminar <em>worker2</em> del procesamiento, <code class="docutils literal notranslate"><span class="pre">clusterApply</span></code> le envía la cuarta posición (<code class="docutils literal notranslate"><span class="pre">clusterApply</span></code> aprovecha la característica que tiene <em>R</em> de reciclar operaciones).</p>
<div class="cell tag_output_scroll docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">clusterApply</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">p</span><span class="p">,</span><span class="n">function</span><span class="p">(</span><span class="n">dummy</span><span class="p">)</span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Hello world!&quot;</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[1]]
[1] &quot;Hello world!&quot;

[[2]]
[1] &quot;Hello world!&quot;

[[3]]
[1] &quot;Hello world!&quot;

[[4]]
[1] &quot;Hello world!&quot;

[[5]]
[1] &quot;Hello world!&quot;

[[6]]
[1] &quot;Hello world!&quot;

[[7]]
[1] &quot;Hello world!&quot;

[[8]]
[1] &quot;Hello world!&quot;

[[9]]
[1] &quot;Hello world!&quot;

[[10]]
[1] &quot;Hello world!&quot;

[[11]]
[1] &quot;Hello world!&quot;

[[12]]
[1] &quot;Hello world!&quot;

[[13]]
[1] &quot;Hello world!&quot;

[[14]]
[1] &quot;Hello world!&quot;

[[15]]
[1] &quot;Hello world!&quot;

[[16]]
[1] &quot;Hello world!&quot;

[[17]]
[1] &quot;Hello world!&quot;

[[18]]
[1] &quot;Hello world!&quot;

[[19]]
[1] &quot;Hello world!&quot;

[[20]]
[1] &quot;Hello world!&quot;

[[21]]
[1] &quot;Hello world!&quot;

[[22]]
[1] &quot;Hello world!&quot;

[[23]]
[1] &quot;Hello world!&quot;

[[24]]
[1] &quot;Hello world!&quot;

[[25]]
[1] &quot;Hello world!&quot;

[[26]]
[1] &quot;Hello world!&quot;

[[27]]
[1] &quot;Hello world!&quot;

[[28]]
[1] &quot;Hello world!&quot;

[[29]]
[1] &quot;Hello world!&quot;

[[30]]
[1] &quot;Hello world!&quot;

[[31]]
[1] &quot;Hello world!&quot;

[[32]]
[1] &quot;Hello world!&quot;

[[33]]
[1] &quot;Hello world!&quot;

[[34]]
[1] &quot;Hello world!&quot;

[[35]]
[1] &quot;Hello world!&quot;

[[36]]
[1] &quot;Hello world!&quot;

[[37]]
[1] &quot;Hello world!&quot;

[[38]]
[1] &quot;Hello world!&quot;

[[39]]
[1] &quot;Hello world!&quot;

[[40]]
[1] &quot;Hello world!&quot;

[[41]]
[1] &quot;Hello world!&quot;

[[42]]
[1] &quot;Hello world!&quot;

[[43]]
[1] &quot;Hello world!&quot;

[[44]]
[1] &quot;Hello world!&quot;

[[45]]
[1] &quot;Hello world!&quot;

[[46]]
[1] &quot;Hello world!&quot;

[[47]]
[1] &quot;Hello world!&quot;

[[48]]
[1] &quot;Hello world!&quot;

[[49]]
[1] &quot;Hello world!&quot;

[[50]]
[1] &quot;Hello world!&quot;

[[51]]
[1] &quot;Hello world!&quot;

[[52]]
[1] &quot;Hello world!&quot;

[[53]]
[1] &quot;Hello world!&quot;

[[54]]
[1] &quot;Hello world!&quot;

[[55]]
[1] &quot;Hello world!&quot;

[[56]]
[1] &quot;Hello world!&quot;

[[57]]
[1] &quot;Hello world!&quot;

[[58]]
[1] &quot;Hello world!&quot;

[[59]]
[1] &quot;Hello world!&quot;

[[60]]
[1] &quot;Hello world!&quot;

[[61]]
[1] &quot;Hello world!&quot;

[[62]]
[1] &quot;Hello world!&quot;

[[63]]
[1] &quot;Hello world!&quot;

[[64]]
[1] &quot;Hello world!&quot;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">clusterApply</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="mi">5</span><span class="p">,</span><span class="n">function</span><span class="p">(</span><span class="n">dummy</span><span class="p">)</span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Hello world!&quot;</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[1]]
[1] &quot;Hello world!&quot;

[[2]]
[1] &quot;Hello world!&quot;

[[3]]
[1] &quot;Hello world!&quot;

[[4]]
[1] &quot;Hello world!&quot;

[[5]]
[1] &quot;Hello world!&quot;
</pre></div>
</div>
</div>
</div>
<div class="tip admonition">
<p class="admonition-title">Observación</p>
<p>Obsérvese que el resultado de <code class="docutils literal notranslate"><span class="pre">clusterApply</span></code> es una lista.</p>
</div>
</div>
</div>
<div class="section" id="ejemplo-de-pasar-argumentos-via-clusterexport">
<h3>Ejemplo de pasar argumentos vía <code class="docutils literal notranslate"><span class="pre">clusterExport</span></code><a class="headerlink" href="#ejemplo-de-pasar-argumentos-via-clusterexport" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">clusterExport</span></code> nos permite enviar valores de variables definidas en el <em>workspace global</em> de <em>manager</em> hacia los <em>workspaces</em> de cada <em>worker</em> bajo los mismos nombres de variables:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">s</span> <span class="o">&lt;-</span> <span class="s2">&quot;Hola mundo!&quot;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">clusterExport</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span><span class="s1">&#39;s&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_output_scroll docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">clusterApply</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">p</span><span class="p">,</span><span class="n">function</span><span class="p">(</span><span class="n">dummy</span><span class="p">)</span><span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[1]]
[1] &quot;Hola mundo!&quot;

[[2]]
[1] &quot;Hola mundo!&quot;

[[3]]
[1] &quot;Hola mundo!&quot;

[[4]]
[1] &quot;Hola mundo!&quot;

[[5]]
[1] &quot;Hola mundo!&quot;

[[6]]
[1] &quot;Hola mundo!&quot;

[[7]]
[1] &quot;Hola mundo!&quot;

[[8]]
[1] &quot;Hola mundo!&quot;

[[9]]
[1] &quot;Hola mundo!&quot;

[[10]]
[1] &quot;Hola mundo!&quot;

[[11]]
[1] &quot;Hola mundo!&quot;

[[12]]
[1] &quot;Hola mundo!&quot;

[[13]]
[1] &quot;Hola mundo!&quot;

[[14]]
[1] &quot;Hola mundo!&quot;

[[15]]
[1] &quot;Hola mundo!&quot;

[[16]]
[1] &quot;Hola mundo!&quot;

[[17]]
[1] &quot;Hola mundo!&quot;

[[18]]
[1] &quot;Hola mundo!&quot;

[[19]]
[1] &quot;Hola mundo!&quot;

[[20]]
[1] &quot;Hola mundo!&quot;

[[21]]
[1] &quot;Hola mundo!&quot;

[[22]]
[1] &quot;Hola mundo!&quot;

[[23]]
[1] &quot;Hola mundo!&quot;

[[24]]
[1] &quot;Hola mundo!&quot;

[[25]]
[1] &quot;Hola mundo!&quot;

[[26]]
[1] &quot;Hola mundo!&quot;

[[27]]
[1] &quot;Hola mundo!&quot;

[[28]]
[1] &quot;Hola mundo!&quot;

[[29]]
[1] &quot;Hola mundo!&quot;

[[30]]
[1] &quot;Hola mundo!&quot;

[[31]]
[1] &quot;Hola mundo!&quot;

[[32]]
[1] &quot;Hola mundo!&quot;

[[33]]
[1] &quot;Hola mundo!&quot;

[[34]]
[1] &quot;Hola mundo!&quot;

[[35]]
[1] &quot;Hola mundo!&quot;

[[36]]
[1] &quot;Hola mundo!&quot;

[[37]]
[1] &quot;Hola mundo!&quot;

[[38]]
[1] &quot;Hola mundo!&quot;

[[39]]
[1] &quot;Hola mundo!&quot;

[[40]]
[1] &quot;Hola mundo!&quot;

[[41]]
[1] &quot;Hola mundo!&quot;

[[42]]
[1] &quot;Hola mundo!&quot;

[[43]]
[1] &quot;Hola mundo!&quot;

[[44]]
[1] &quot;Hola mundo!&quot;

[[45]]
[1] &quot;Hola mundo!&quot;

[[46]]
[1] &quot;Hola mundo!&quot;

[[47]]
[1] &quot;Hola mundo!&quot;

[[48]]
[1] &quot;Hola mundo!&quot;

[[49]]
[1] &quot;Hola mundo!&quot;

[[50]]
[1] &quot;Hola mundo!&quot;

[[51]]
[1] &quot;Hola mundo!&quot;

[[52]]
[1] &quot;Hola mundo!&quot;

[[53]]
[1] &quot;Hola mundo!&quot;

[[54]]
[1] &quot;Hola mundo!&quot;

[[55]]
[1] &quot;Hola mundo!&quot;

[[56]]
[1] &quot;Hola mundo!&quot;

[[57]]
[1] &quot;Hola mundo!&quot;

[[58]]
[1] &quot;Hola mundo!&quot;

[[59]]
[1] &quot;Hola mundo!&quot;

[[60]]
[1] &quot;Hola mundo!&quot;

[[61]]
[1] &quot;Hola mundo!&quot;

[[62]]
[1] &quot;Hola mundo!&quot;

[[63]]
[1] &quot;Hola mundo!&quot;

[[64]]
[1] &quot;Hola mundo!&quot;
</pre></div>
</div>
</div>
</div>
<p><strong>¿Qué pasa si mi <code class="docutils literal notranslate"><span class="pre">clusterExport</span></code> está dentro de una función?</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">myfun</span> <span class="o">&lt;-</span> <span class="n">function</span><span class="p">(){</span>
    <span class="n">s_local</span><span class="o">&lt;-</span><span class="s2">&quot;Hola mundo! usando variable local a myfun&quot;</span>
    <span class="n">clusterExport</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span><span class="s2">&quot;s_local&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">clusterApply</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">p</span><span class="p">,</span><span class="n">function</span><span class="p">(</span><span class="n">dummy</span><span class="p">)</span><span class="nb">print</span><span class="p">(</span><span class="n">s_local</span><span class="p">)))</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">myfun</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span>Error in get(name, envir = envir): object &#39;s_local&#39; not found
Traceback:

1. print(myfun())
2. myfun()
3. clusterExport(cl, &quot;s_local&quot;)   # at line 3 of file &lt;text&gt;
4. clusterCall(cl, gets, name, get(name, envir = envir))
5. sendCall(cl[[i]], fun, list(...))
6. postNode(con, &quot;EXEC&quot;, list(fun = fun, args = args, return = return, 
 .     tag = tag))
7. sendData(con, list(type = type, data = value, tag = tag))
8. sendData.SOCKnode(con, list(type = type, data = value, tag = tag))
9. serialize(data, node$con)
10. get(name, envir = envir)
</pre></div>
</div>
</div>
</div>
<p>Lo anterior lo podemos resolver con <em>superassignment</em>. Ver <a class="reference external" href="https://stat.ethz.ch/pipermail/r-help/2011-April/275905.html">What does the “&lt;&lt;-” operator mean?</a> y <a class="reference external" href="https://stackoverflow.com/questions/2628621/how-do-you-use-scoping-assignment-in-r">how-do-you-use-scoping-assignment-in-r</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">myfun2</span> <span class="o">&lt;-</span> <span class="n">function</span><span class="p">(){</span>
    <span class="n">s_global</span> <span class="o">&lt;&lt;-</span> <span class="s2">&quot;Hola mundo! usando superassignment en mifun2&quot;</span> <span class="c1">#&lt;&lt;- superassignment</span>
    <span class="n">clusterExport</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span><span class="s2">&quot;s_global&quot;</span><span class="p">)</span>
    <span class="n">clusterApply</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">p</span><span class="p">,</span><span class="n">function</span><span class="p">(</span><span class="n">dummy</span><span class="p">)</span><span class="nb">print</span><span class="p">(</span><span class="n">s_global</span><span class="p">))</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_output_scroll docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">myfun2</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[1]]
[1] &quot;Hola mundo! usando superassignment en mifun2&quot;

[[2]]
[1] &quot;Hola mundo! usando superassignment en mifun2&quot;

[[3]]
[1] &quot;Hola mundo! usando superassignment en mifun2&quot;

[[4]]
[1] &quot;Hola mundo! usando superassignment en mifun2&quot;

[[5]]
[1] &quot;Hola mundo! usando superassignment en mifun2&quot;

[[6]]
[1] &quot;Hola mundo! usando superassignment en mifun2&quot;

[[7]]
[1] &quot;Hola mundo! usando superassignment en mifun2&quot;

[[8]]
[1] &quot;Hola mundo! usando superassignment en mifun2&quot;

[[9]]
[1] &quot;Hola mundo! usando superassignment en mifun2&quot;

[[10]]
[1] &quot;Hola mundo! usando superassignment en mifun2&quot;

[[11]]
[1] &quot;Hola mundo! usando superassignment en mifun2&quot;

[[12]]
[1] &quot;Hola mundo! usando superassignment en mifun2&quot;

[[13]]
[1] &quot;Hola mundo! usando superassignment en mifun2&quot;

[[14]]
[1] &quot;Hola mundo! usando superassignment en mifun2&quot;

[[15]]
[1] &quot;Hola mundo! usando superassignment en mifun2&quot;

[[16]]
[1] &quot;Hola mundo! usando superassignment en mifun2&quot;

[[17]]
[1] &quot;Hola mundo! usando superassignment en mifun2&quot;

[[18]]
[1] &quot;Hola mundo! usando superassignment en mifun2&quot;

[[19]]
[1] &quot;Hola mundo! usando superassignment en mifun2&quot;

[[20]]
[1] &quot;Hola mundo! usando superassignment en mifun2&quot;

[[21]]
[1] &quot;Hola mundo! usando superassignment en mifun2&quot;

[[22]]
[1] &quot;Hola mundo! usando superassignment en mifun2&quot;

[[23]]
[1] &quot;Hola mundo! usando superassignment en mifun2&quot;

[[24]]
[1] &quot;Hola mundo! usando superassignment en mifun2&quot;

[[25]]
[1] &quot;Hola mundo! usando superassignment en mifun2&quot;

[[26]]
[1] &quot;Hola mundo! usando superassignment en mifun2&quot;

[[27]]
[1] &quot;Hola mundo! usando superassignment en mifun2&quot;

[[28]]
[1] &quot;Hola mundo! usando superassignment en mifun2&quot;

[[29]]
[1] &quot;Hola mundo! usando superassignment en mifun2&quot;

[[30]]
[1] &quot;Hola mundo! usando superassignment en mifun2&quot;

[[31]]
[1] &quot;Hola mundo! usando superassignment en mifun2&quot;

[[32]]
[1] &quot;Hola mundo! usando superassignment en mifun2&quot;

[[33]]
[1] &quot;Hola mundo! usando superassignment en mifun2&quot;

[[34]]
[1] &quot;Hola mundo! usando superassignment en mifun2&quot;

[[35]]
[1] &quot;Hola mundo! usando superassignment en mifun2&quot;

[[36]]
[1] &quot;Hola mundo! usando superassignment en mifun2&quot;

[[37]]
[1] &quot;Hola mundo! usando superassignment en mifun2&quot;

[[38]]
[1] &quot;Hola mundo! usando superassignment en mifun2&quot;

[[39]]
[1] &quot;Hola mundo! usando superassignment en mifun2&quot;

[[40]]
[1] &quot;Hola mundo! usando superassignment en mifun2&quot;

[[41]]
[1] &quot;Hola mundo! usando superassignment en mifun2&quot;

[[42]]
[1] &quot;Hola mundo! usando superassignment en mifun2&quot;

[[43]]
[1] &quot;Hola mundo! usando superassignment en mifun2&quot;

[[44]]
[1] &quot;Hola mundo! usando superassignment en mifun2&quot;

[[45]]
[1] &quot;Hola mundo! usando superassignment en mifun2&quot;

[[46]]
[1] &quot;Hola mundo! usando superassignment en mifun2&quot;

[[47]]
[1] &quot;Hola mundo! usando superassignment en mifun2&quot;

[[48]]
[1] &quot;Hola mundo! usando superassignment en mifun2&quot;

[[49]]
[1] &quot;Hola mundo! usando superassignment en mifun2&quot;

[[50]]
[1] &quot;Hola mundo! usando superassignment en mifun2&quot;

[[51]]
[1] &quot;Hola mundo! usando superassignment en mifun2&quot;

[[52]]
[1] &quot;Hola mundo! usando superassignment en mifun2&quot;

[[53]]
[1] &quot;Hola mundo! usando superassignment en mifun2&quot;

[[54]]
[1] &quot;Hola mundo! usando superassignment en mifun2&quot;

[[55]]
[1] &quot;Hola mundo! usando superassignment en mifun2&quot;

[[56]]
[1] &quot;Hola mundo! usando superassignment en mifun2&quot;

[[57]]
[1] &quot;Hola mundo! usando superassignment en mifun2&quot;

[[58]]
[1] &quot;Hola mundo! usando superassignment en mifun2&quot;

[[59]]
[1] &quot;Hola mundo! usando superassignment en mifun2&quot;

[[60]]
[1] &quot;Hola mundo! usando superassignment en mifun2&quot;

[[61]]
[1] &quot;Hola mundo! usando superassignment en mifun2&quot;

[[62]]
[1] &quot;Hola mundo! usando superassignment en mifun2&quot;

[[63]]
[1] &quot;Hola mundo! usando superassignment en mifun2&quot;

[[64]]
[1] &quot;Hola mundo! usando superassignment en mifun2&quot;
</pre></div>
</div>
</div>
</div>
<p>O bien con <code class="docutils literal notranslate"><span class="pre">environment()</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">myfun3</span> <span class="o">&lt;-</span> <span class="n">function</span><span class="p">(</span><span class="n">s_global2</span><span class="p">){</span>
    <span class="n">clusterExport</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span><span class="s2">&quot;s_global2&quot;</span><span class="p">)</span>
    <span class="n">clusterApply</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">p</span><span class="p">,</span><span class="n">function</span><span class="p">(</span><span class="n">dummy</span><span class="p">)</span><span class="nb">print</span><span class="p">(</span><span class="n">s_global2</span><span class="p">))</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">myfun3</span><span class="p">(</span><span class="s2">&quot;Hola mundo! usando variable local a mifun3&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span>Error in get(name, envir = envir): object &#39;s_global2&#39; not found
Traceback:

1. print(myfun3(&quot;Hola mundo! usando variable local a mifun3&quot;))
2. myfun3(&quot;Hola mundo! usando variable local a mifun3&quot;)
3. clusterExport(cl, &quot;s_global2&quot;)   # at line 2 of file &lt;text&gt;
4. clusterCall(cl, gets, name, get(name, envir = envir))
5. sendCall(cl[[i]], fun, list(...))
6. postNode(con, &quot;EXEC&quot;, list(fun = fun, args = args, return = return, 
 .     tag = tag))
7. sendData(con, list(type = type, data = value, tag = tag))
8. sendData.SOCKnode(con, list(type = type, data = value, tag = tag))
9. serialize(data, node$con)
10. get(name, envir = envir)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">myfun4</span><span class="o">&lt;-</span><span class="n">function</span><span class="p">(</span><span class="n">s_global2</span><span class="p">){</span>
    <span class="n">clusterExport</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span><span class="s2">&quot;s_global2&quot;</span><span class="p">,</span> <span class="n">envir</span><span class="o">=</span><span class="n">environment</span><span class="p">())</span>
    <span class="n">clusterApply</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">p</span><span class="p">,</span><span class="n">function</span><span class="p">(</span><span class="n">dummy</span><span class="p">)</span><span class="nb">print</span><span class="p">(</span><span class="n">s_global2</span><span class="p">))</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_output_scroll docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">myfun4</span><span class="p">(</span><span class="s2">&quot;Hola mundo! usando environment()&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[[1]]
[1] &quot;Hola mundo! usando environment()&quot;

[[2]]
[1] &quot;Hola mundo! usando environment()&quot;

[[3]]
[1] &quot;Hola mundo! usando environment()&quot;

[[4]]
[1] &quot;Hola mundo! usando environment()&quot;

[[5]]
[1] &quot;Hola mundo! usando environment()&quot;

[[6]]
[1] &quot;Hola mundo! usando environment()&quot;

[[7]]
[1] &quot;Hola mundo! usando environment()&quot;

[[8]]
[1] &quot;Hola mundo! usando environment()&quot;

[[9]]
[1] &quot;Hola mundo! usando environment()&quot;

[[10]]
[1] &quot;Hola mundo! usando environment()&quot;

[[11]]
[1] &quot;Hola mundo! usando environment()&quot;

[[12]]
[1] &quot;Hola mundo! usando environment()&quot;

[[13]]
[1] &quot;Hola mundo! usando environment()&quot;

[[14]]
[1] &quot;Hola mundo! usando environment()&quot;

[[15]]
[1] &quot;Hola mundo! usando environment()&quot;

[[16]]
[1] &quot;Hola mundo! usando environment()&quot;

[[17]]
[1] &quot;Hola mundo! usando environment()&quot;

[[18]]
[1] &quot;Hola mundo! usando environment()&quot;

[[19]]
[1] &quot;Hola mundo! usando environment()&quot;

[[20]]
[1] &quot;Hola mundo! usando environment()&quot;

[[21]]
[1] &quot;Hola mundo! usando environment()&quot;

[[22]]
[1] &quot;Hola mundo! usando environment()&quot;

[[23]]
[1] &quot;Hola mundo! usando environment()&quot;

[[24]]
[1] &quot;Hola mundo! usando environment()&quot;

[[25]]
[1] &quot;Hola mundo! usando environment()&quot;

[[26]]
[1] &quot;Hola mundo! usando environment()&quot;

[[27]]
[1] &quot;Hola mundo! usando environment()&quot;

[[28]]
[1] &quot;Hola mundo! usando environment()&quot;

[[29]]
[1] &quot;Hola mundo! usando environment()&quot;

[[30]]
[1] &quot;Hola mundo! usando environment()&quot;

[[31]]
[1] &quot;Hola mundo! usando environment()&quot;

[[32]]
[1] &quot;Hola mundo! usando environment()&quot;

[[33]]
[1] &quot;Hola mundo! usando environment()&quot;

[[34]]
[1] &quot;Hola mundo! usando environment()&quot;

[[35]]
[1] &quot;Hola mundo! usando environment()&quot;

[[36]]
[1] &quot;Hola mundo! usando environment()&quot;

[[37]]
[1] &quot;Hola mundo! usando environment()&quot;

[[38]]
[1] &quot;Hola mundo! usando environment()&quot;

[[39]]
[1] &quot;Hola mundo! usando environment()&quot;

[[40]]
[1] &quot;Hola mundo! usando environment()&quot;

[[41]]
[1] &quot;Hola mundo! usando environment()&quot;

[[42]]
[1] &quot;Hola mundo! usando environment()&quot;

[[43]]
[1] &quot;Hola mundo! usando environment()&quot;

[[44]]
[1] &quot;Hola mundo! usando environment()&quot;

[[45]]
[1] &quot;Hola mundo! usando environment()&quot;

[[46]]
[1] &quot;Hola mundo! usando environment()&quot;

[[47]]
[1] &quot;Hola mundo! usando environment()&quot;

[[48]]
[1] &quot;Hola mundo! usando environment()&quot;

[[49]]
[1] &quot;Hola mundo! usando environment()&quot;

[[50]]
[1] &quot;Hola mundo! usando environment()&quot;

[[51]]
[1] &quot;Hola mundo! usando environment()&quot;

[[52]]
[1] &quot;Hola mundo! usando environment()&quot;

[[53]]
[1] &quot;Hola mundo! usando environment()&quot;

[[54]]
[1] &quot;Hola mundo! usando environment()&quot;

[[55]]
[1] &quot;Hola mundo! usando environment()&quot;

[[56]]
[1] &quot;Hola mundo! usando environment()&quot;

[[57]]
[1] &quot;Hola mundo! usando environment()&quot;

[[58]]
[1] &quot;Hola mundo! usando environment()&quot;

[[59]]
[1] &quot;Hola mundo! usando environment()&quot;

[[60]]
[1] &quot;Hola mundo! usando environment()&quot;

[[61]]
[1] &quot;Hola mundo! usando environment()&quot;

[[62]]
[1] &quot;Hola mundo! usando environment()&quot;

[[63]]
[1] &quot;Hola mundo! usando environment()&quot;

[[64]]
[1] &quot;Hola mundo! usando environment()&quot;
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="ejemplo-regla-compuesta-del-rectangulo-con-clusterapply">
<h3>Ejemplo regla compuesta del rectángulo con <code class="docutils literal notranslate"><span class="pre">clusterApply</span></code><a class="headerlink" href="#ejemplo-regla-compuesta-del-rectangulo-con-clusterapply" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">library</span><span class="p">(</span><span class="n">microbenchmark</span><span class="p">)</span>
<span class="n">library</span><span class="p">(</span><span class="n">tictoc</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="o">&lt;-</span> <span class="n">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">&lt;-</span> <span class="mi">0</span>
<span class="n">b</span> <span class="o">&lt;-</span> <span class="mi">1</span>
<span class="n">n</span> <span class="o">&lt;-</span> <span class="mi">10</span><span class="o">**</span><span class="mi">7</span>
<span class="n">h_hat</span> <span class="o">&lt;-</span> <span class="p">(</span><span class="n">b</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">/</span><span class="n">n</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_subintervals_per_subprocess</span> <span class="o">&lt;-</span> <span class="k">as</span><span class="o">.</span><span class="n">integer</span><span class="p">(</span><span class="n">n</span><span class="o">/</span><span class="n">p</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="admonition-comentario admonition">
<p class="admonition-title">Comentario</p>
<p><code class="docutils literal notranslate"><span class="pre">n_subintervals_per_subprocess</span></code> es el número de subintervalos por <em>core</em>. Se asume que <code class="docutils literal notranslate"><span class="pre">n</span></code> es divisible por <code class="docutils literal notranslate"><span class="pre">p</span></code>. Si no se cumple esto, se puede definir <code class="docutils literal notranslate"><span class="pre">n_subintervals_per_subprocess</span> <span class="pre">&lt;-</span> <span class="pre">int(n/p)</span></code> habiendo definido <code class="docutils literal notranslate"><span class="pre">n</span></code> primero y redefinir <code class="docutils literal notranslate"><span class="pre">n</span></code> como: <code class="docutils literal notranslate"><span class="pre">n</span> <span class="pre">&lt;-</span> <span class="pre">p*n_subintervals_per_subprocess</span></code></p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">relative_error</span> <span class="o">&lt;-</span> <span class="n">function</span><span class="p">(</span><span class="n">aprox</span><span class="p">,</span><span class="n">obj</span><span class="p">)</span><span class="nb">abs</span><span class="p">(</span><span class="n">aprox</span><span class="o">-</span><span class="n">obj</span><span class="p">)</span><span class="o">/</span><span class="nb">abs</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sprintf</span><span class="p">(</span><span class="s2">&quot;número de subintervalos: </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">'número de subintervalos: 10000000'</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sprintf</span><span class="p">(</span><span class="s2">&quot;número de subintervalos por proceso: </span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">n_subintervals_per_subprocess</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">'número de subintervalos por proceso: 156250'</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Rcf_parallel_cl_apply</span> <span class="o">&lt;-</span> <span class="n">function</span><span class="p">(</span><span class="n">my_id</span><span class="p">){</span>
    <span class="n">begin</span> <span class="o">&lt;-</span> <span class="n">my_id</span><span class="o">*</span><span class="n">n_subintervals_per_subprocess</span>
    <span class="n">end</span> <span class="o">&lt;-</span> <span class="n">begin</span><span class="o">+</span><span class="n">n_subintervals_per_subprocess</span>
    <span class="n">sum_res</span> <span class="o">&lt;-</span> <span class="mi">0</span>
    <span class="k">for</span><span class="p">(</span><span class="n">j</span> <span class="ow">in</span> <span class="n">begin</span><span class="p">:(</span><span class="n">end</span><span class="o">-</span><span class="mi">1</span><span class="p">)){</span>
        <span class="n">x</span> <span class="o">&lt;-</span> <span class="n">a</span><span class="o">+</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">h_hat</span>
        <span class="n">sum_res</span> <span class="o">&lt;-</span> <span class="n">sum_res</span><span class="o">+</span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">sum_res</span>    
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">clusterExport</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span><span class="n">c</span><span class="p">(</span><span class="s2">&quot;n_subintervals_per_subprocess&quot;</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="s1">&#39;f&#39;</span><span class="p">,</span><span class="s2">&quot;h_hat&quot;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<p>Utilizamos la función <code class="docutils literal notranslate"><span class="pre">Reduce</span></code> y la función <code class="docutils literal notranslate"><span class="pre">sum</span></code> a la lista que resulta de <code class="docutils literal notranslate"><span class="pre">clusterApply</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tic</span><span class="p">(</span><span class="s2">&quot;regla Rcf_parallel_cl_apply&quot;</span><span class="p">)</span>
<span class="n">result_cl_apply</span>  <span class="o">&lt;-</span> <span class="n">clusterApply</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span><span class="mi">0</span><span class="p">:(</span><span class="n">p</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="n">Rcf_parallel_cl_apply</span><span class="p">)</span>
<span class="n">res_rcf_cl_apply</span> <span class="o">&lt;-</span> <span class="n">h_hat</span><span class="o">*</span><span class="n">Reduce</span><span class="p">(</span><span class="nb">sum</span><span class="p">,</span><span class="n">result_cl_apply</span><span class="p">)</span>
<span class="n">toc</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>regla Rcf_parallel_cl_apply: 0.562 sec elapsed
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">obj</span> <span class="o">&lt;-</span> <span class="n">integrate</span><span class="p">(</span><span class="n">Vectorize</span><span class="p">(</span><span class="n">f</span><span class="p">),</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>print(relative_error(res_rcf_cl_apply,obj$value))
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1] 1.486592e-15
</pre></div>
</div>
</div>
</div>
<p>La encapsulamos en una función para pasarla a <code class="docutils literal notranslate"><span class="pre">microbenchmark</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">clapply</span> <span class="o">&lt;-</span> <span class="n">function</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span><span class="n">p</span><span class="p">){</span>
    <span class="n">result_cl_apply</span> <span class="o">&lt;-</span> <span class="n">clusterApply</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span><span class="mi">0</span><span class="p">:(</span><span class="n">p</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="n">Rcf_parallel_cl_apply</span><span class="p">)</span>
    <span class="n">res_rcf_cl_apply</span> <span class="o">&lt;-</span> <span class="n">h_hat</span><span class="o">*</span><span class="n">Reduce</span><span class="p">(</span><span class="nb">sum</span><span class="p">,</span><span class="n">result_cl_apply</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mbk</span><span class="o">&lt;-</span><span class="n">microbenchmark</span><span class="p">(</span>
    <span class="n">clapply</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span><span class="n">p</span><span class="p">),</span>
    <span class="n">times</span><span class="o">=</span><span class="mi">10</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">mbk</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Unit: milliseconds
           expr      min       lq     mean   median       uq     max neval
 clapply(cl, p) 274.0143 299.3502 335.1274 322.0482 361.4857 457.578    10
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="ejemplo-regla-compuesta-del-rectangulo-con-clustersplit">
<h3>Ejemplo regla compuesta del rectángulo con <code class="docutils literal notranslate"><span class="pre">clusterSplit</span></code><a class="headerlink" href="#ejemplo-regla-compuesta-del-rectangulo-con-clustersplit" title="Permalink to this headline">¶</a></h3>
<p>La función <code class="docutils literal notranslate"><span class="pre">clusterSplit</span></code> divide una secuencia en <em>chunks</em> de subsecuencias consecutivas. El número de <em>chunks</em> que regresa es igual al número de <em>workers</em>. <code class="docutils literal notranslate"><span class="pre">clusterSplit</span></code> intenta que los <em>chunks</em> sean similares en longitud y la división se realiza en <em>manager</em>.</p>
<p>En la siguiente implementación se recibe un <code class="docutils literal notranslate"><span class="pre">chunk</span></code> de nodos.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Rcf_parallel_cl_split</span><span class="o">&lt;-</span><span class="n">function</span><span class="p">(</span><span class="n">chunk</span><span class="p">){</span>
    <span class="n">sum_res</span> <span class="o">&lt;-</span> <span class="mi">0</span>
    <span class="k">for</span><span class="p">(</span><span class="n">x</span> <span class="ow">in</span> <span class="n">chunk</span><span class="p">){</span>
        <span class="n">sum_res</span> <span class="o">&lt;-</span> <span class="n">sum_res</span><span class="o">+</span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">sum_res</span>    
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tic</span><span class="p">()</span>
<span class="c1">#chunks for nodes using clusterSplit:</span>
<span class="n">chunks</span> <span class="o">&lt;-</span> <span class="n">clusterSplit</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span><span class="n">vapply</span><span class="p">(</span><span class="mi">0</span><span class="p">:(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="n">function</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="n">a</span><span class="o">+</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span><span class="o">*</span><span class="n">h_hat</span><span class="p">,</span><span class="n">numeric</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span>
<span class="c1">#call clusterApply</span>
<span class="n">result_cl_apply</span> <span class="o">&lt;-</span> <span class="n">clusterApply</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span><span class="n">chunks</span><span class="p">,</span><span class="n">Rcf_parallel_cl_split</span><span class="p">)</span>
<span class="n">res_rcf_cl_split</span> <span class="o">&lt;-</span> <span class="n">h_hat</span><span class="o">*</span><span class="n">Reduce</span><span class="p">(</span><span class="nb">sum</span><span class="p">,</span><span class="n">result_cl_apply</span><span class="p">)</span>
<span class="n">toc</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>9.949 sec elapsed
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>print(relative_error(res_rcf_cl_split,obj$value))
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1] 2.824525e-15
</pre></div>
</div>
</div>
</div>
<p>En la siguiente implementación, se divide en chunks la secuencia: <code class="docutils literal notranslate"><span class="pre">0,1,...,n-1</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">Rcf_parallel_cl_split_2</span> <span class="o">&lt;-</span> <span class="n">function</span><span class="p">(</span><span class="n">chunk</span><span class="p">){</span>
    <span class="n">n_s_sub</span> <span class="o">&lt;-</span> <span class="n">length</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span>
    <span class="n">begin</span> <span class="o">&lt;-</span> <span class="n">chunk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">end</span> <span class="o">&lt;-</span> <span class="n">begin</span><span class="o">+</span><span class="n">n_s_sub</span>
    <span class="n">sum_res</span> <span class="o">&lt;-</span> <span class="mi">0</span>
    <span class="k">for</span><span class="p">(</span><span class="n">j</span> <span class="ow">in</span> <span class="n">begin</span><span class="p">:(</span><span class="n">end</span><span class="o">-</span><span class="mi">1</span><span class="p">)){</span>
        <span class="n">x</span> <span class="o">&lt;-</span> <span class="n">a</span><span class="o">+</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">h_hat</span>
        <span class="n">sum_res</span> <span class="o">&lt;-</span> <span class="n">sum_res</span><span class="o">+</span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">sum_res</span>    
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tic</span><span class="p">()</span>
<span class="c1">#se crean los chunks de la secuencia: 0,1,...,n-1</span>
<span class="n">chunks</span> <span class="o">&lt;-</span> <span class="n">clusterSplit</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span><span class="mi">0</span><span class="p">:(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> 
<span class="n">result_cl_apply</span> <span class="o">&lt;-</span> <span class="n">clusterApply</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span><span class="n">chunks</span><span class="p">,</span><span class="n">Rcf_parallel_cl_split_2</span><span class="p">)</span>
<span class="n">res_rcf_cl_split_2</span> <span class="o">&lt;-</span> <span class="n">h_hat</span><span class="o">*</span><span class="n">Reduce</span><span class="p">(</span><span class="nb">sum</span><span class="p">,</span><span class="n">result_cl_apply</span><span class="p">)</span>
<span class="n">toc</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.538 sec elapsed
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>print(relative_error(res_rcf_cl_split_2,obj$value))
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1] 2.824525e-15
</pre></div>
</div>
</div>
</div>
<p>Medimos tiempos con <em>Microbenchmark</em>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">clapply2</span> <span class="o">&lt;-</span> <span class="n">function</span><span class="p">(</span><span class="n">cl</span><span class="p">){</span>
    <span class="n">chunks</span> <span class="o">&lt;-</span> <span class="n">clusterSplit</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span><span class="n">vapply</span><span class="p">(</span><span class="mi">0</span><span class="p">:(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="n">function</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="n">a</span><span class="o">+</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span><span class="o">*</span><span class="n">h_hat</span><span class="p">,</span><span class="n">numeric</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span> 
    <span class="n">result_cl_apply</span> <span class="o">&lt;-</span> <span class="n">clusterApply</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span><span class="n">chunks</span><span class="p">,</span><span class="n">Rcf_parallel_cl_split</span><span class="p">)</span>
    <span class="n">res_rcf_cl_split</span> <span class="o">&lt;-</span> <span class="n">h_hat</span><span class="o">*</span><span class="n">Reduce</span><span class="p">(</span><span class="nb">sum</span><span class="p">,</span><span class="n">result_cl_apply</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">clapply3</span> <span class="o">&lt;-</span> <span class="n">function</span><span class="p">(</span><span class="n">cl</span><span class="p">){</span>
    <span class="n">chunks</span> <span class="o">&lt;-</span> <span class="n">clusterSplit</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span><span class="mi">0</span><span class="p">:(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">result_cl_apply</span> <span class="o">&lt;-</span> <span class="n">clusterApply</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span><span class="n">chunks</span><span class="p">,</span><span class="n">Rcf_parallel_cl_split_2</span><span class="p">)</span>
    <span class="n">res_rcf_cl_split_2</span> <span class="o">&lt;-</span> <span class="n">h_hat</span><span class="o">*</span><span class="n">Reduce</span><span class="p">(</span><span class="nb">sum</span><span class="p">,</span><span class="n">result_cl_apply</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mbk</span><span class="o">&lt;-</span><span class="n">microbenchmark</span><span class="p">(</span>
    <span class="n">clapply</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span><span class="n">p</span><span class="p">),</span>
    <span class="n">clapply2</span><span class="p">(</span><span class="n">cl</span><span class="p">),</span>
    <span class="n">clapply3</span><span class="p">(</span><span class="n">cl</span><span class="p">),</span>
    <span class="n">times</span><span class="o">=</span><span class="mi">10</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">mbk</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Unit: milliseconds
           expr       min        lq       mean    median       uq        max
 clapply(cl, p)  279.1311  282.8535   305.9289  294.0048  325.548   371.0334
   clapply2(cl) 9692.8472 9737.9523 10064.3089 9856.9876 9932.777 12093.3270
   clapply3(cl) 1341.8627 1463.4982  1484.6908 1478.0374 1539.323  1618.6653
 neval
    10
    10
    10
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id9">
<h3>Gráfica de tiempo de ejecución vs número de procesos<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">library</span><span class="p">(</span><span class="n">ggplot2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Una buena práctica es detener el clúster:</p>
<p><em>It is good practice to shut down the workers by calling stopCluster: however the workers will terminate themselves once the socket on which they are listening for commands becomes unavailable, which it should if the master R session is completed (or its process dies).</em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">stopCluster</span><span class="p">(</span><span class="n">cl</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>En lo siguiente se utiliza <code class="docutils literal notranslate"><span class="pre">Rcf_parallel_cl_apply</span></code> pues tuvo el menor tiempo de ejecución. Usaremos ésta implementación para realizar la gráfica variando el número de procesos de <span class="math notranslate nohighlight">\(1\)</span> hasta <code class="docutils literal notranslate"><span class="pre">detectCores()</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">myfun</span> <span class="o">&lt;-</span> <span class="n">function</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span><span class="n">p</span><span class="p">){</span>
    <span class="n">result_apply</span> <span class="o">&lt;-</span> <span class="n">clusterApply</span><span class="p">(</span><span class="n">cl</span><span class="p">,</span><span class="mi">0</span><span class="p">:(</span><span class="n">p</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span><span class="n">Rcf_parallel_cl_apply</span><span class="p">)</span>
    <span class="n">res_rcf_cl_apply</span> <span class="o">&lt;-</span> <span class="n">h_hat</span><span class="o">*</span><span class="n">Reduce</span><span class="p">(</span><span class="nb">sum</span><span class="p">,</span><span class="n">result_apply</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dim</span> <span class="o">&lt;-</span> <span class="nb">sum</span><span class="p">(</span><span class="n">n</span><span class="o">%%</span><span class="p">(</span><span class="mi">1</span><span class="p">:</span><span class="n">detectCores</span><span class="p">())</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">err_vec</span> <span class="o">&lt;-</span> <span class="n">vector</span><span class="p">(</span><span class="s2">&quot;double&quot;</span><span class="p">,</span> <span class="n">dim</span><span class="p">)</span>
<span class="n">n_cpus</span> <span class="o">&lt;-</span> <span class="n">vector</span><span class="p">(</span><span class="s2">&quot;integer&quot;</span><span class="p">,</span><span class="n">dim</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">i</span><span class="o">&lt;-</span><span class="mi">1</span>
<span class="k">for</span><span class="p">(</span><span class="n">p</span> <span class="ow">in</span> <span class="mi">1</span><span class="p">:</span><span class="n">detectCores</span><span class="p">()){</span>
    <span class="k">if</span><span class="p">(</span><span class="n">n</span><span class="o">%%</span><span class="k">p</span>==0){
        n_subintervals_per_subprocess &lt;- n/p
        cl &lt;- makeCluster(p)
        clusterExport(cl,c(&#39;a&#39;,&#39;f&#39;,&quot;h_hat&quot;,&quot;n_subintervals_per_subprocess&quot;))
        res_my_fun &lt;- myfun(cl,p)
        err_vec[i] &lt;- relative_error(res_my_fun, obj$value)
        n_cpus[i] &lt;- p
        stopCluster(cl)
        i &lt;- i+1
    }
}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">err_vec</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [1] 4.994950e-14 1.441995e-14 2.423145e-14 5.886906e-14 1.382531e-14
 [6] 1.769045e-14 3.716481e-15 3.865140e-15 2.527207e-15 2.973185e-15
[11] 2.229888e-15 2.675866e-15 1.486592e-15
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">n_cpus</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [1]  1  2  4  5  8 10 16 20 25 32 40 50 64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">vector_with_time_medians</span> <span class="o">&lt;-</span> <span class="n">vector</span><span class="p">(</span><span class="s2">&quot;double&quot;</span><span class="p">,</span> <span class="n">dim</span><span class="p">)</span>
<span class="n">n_cpus</span> <span class="o">&lt;-</span> <span class="n">vector</span><span class="p">(</span><span class="s2">&quot;integer&quot;</span><span class="p">,</span><span class="n">dim</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">i</span><span class="o">&lt;-</span><span class="mi">1</span>
<span class="k">for</span><span class="p">(</span><span class="n">p</span> <span class="ow">in</span> <span class="mi">1</span><span class="p">:</span><span class="n">detectCores</span><span class="p">()){</span>
    <span class="k">if</span><span class="p">(</span><span class="n">n</span><span class="o">%%</span><span class="k">p</span>==0){
        n_subintervals_per_subprocess &lt;- n/p
        cl &lt;- makeCluster(p)
        clusterExport(cl,c(&#39;a&#39;,&#39;f&#39;,&quot;h_hat&quot;,&quot;n_subintervals_per_subprocess&quot;))
        df &lt;- print(microbenchmark(myfun(cl,p),times=10,unit=&quot;s&quot;))
        stopCluster(cl)
        vector_with_time_medians[i] &lt;- df$median
        n_cpus[i] &lt;- p
        i &lt;- i+1
    }
}
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Unit: seconds
         expr      min       lq     mean   median       uq      max neval
 myfun(cl, p) 6.880437 6.912525 6.962728 6.951347 6.969166 7.092888    10
Unit: seconds
         expr      min       lq     mean   median       uq     max neval
 myfun(cl, p) 3.521054 3.528644 3.550711 3.537149 3.561584 3.63593    10
Unit: seconds
         expr      min      lq     mean   median       uq      max neval
 myfun(cl, p) 1.810182 1.84642 1.868893 1.855109 1.877132 1.992167    10
Unit: seconds
         expr      min       lq     mean   median       uq     max neval
 myfun(cl, p) 1.497631 1.503919 1.539663 1.513827 1.561826 1.68751    10
Unit: seconds
         expr       min        lq   mean    median       uq      max neval
 myfun(cl, p) 0.9574237 0.9681314 0.9938 0.9926238 1.002309 1.084198    10
Unit: seconds
         expr       min        lq      mean    median        uq       max neval
 myfun(cl, p) 0.7567488 0.7752932 0.8005973 0.7915049 0.8226106 0.8705034    10
Unit: seconds
         expr       min        lq      mean    median        uq       max neval
 myfun(cl, p) 0.4981435 0.5000754 0.5255358 0.5042411 0.5605582 0.6147569    10
Unit: seconds
         expr       min        lq      mean   median       uq       max neval
 myfun(cl, p) 0.4741282 0.6334634 0.6247839 0.644421 0.679061 0.7279318    10
Unit: seconds
         expr       min        lq      mean    median        uq       max neval
 myfun(cl, p) 0.4189323 0.5358796 0.5622284 0.5821805 0.6220992 0.6457455    10
Unit: seconds
         expr       min        lq     mean    median        uq       max neval
 myfun(cl, p) 0.5009026 0.5067084 0.526749 0.5106894 0.5534964 0.5992958    10
Unit: seconds
         expr       min        lq      mean    median        uq       max neval
 myfun(cl, p) 0.3703077 0.4051899 0.4655505 0.4660017 0.5055815 0.5712992    10
Unit: seconds
         expr       min       lq      mean    median        uq       max neval
 myfun(cl, p) 0.3289509 0.333303 0.3752226 0.3503937 0.3883032 0.5635342    10
Unit: seconds
         expr       min        lq      mean    median        uq       max neval
 myfun(cl, p) 0.2982448 0.3310383 0.3636902 0.3519018 0.3622468 0.5368318    10
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">vector_with_time_medians</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [1] 6.9513466 3.5371493 1.8551087 1.5138267 0.9926238 0.7915049 0.5042411
 [8] 0.6444210 0.5821805 0.5106894 0.4660017 0.3503937 0.3519018
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">n_cpus</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> [1]  1  2  4  5  8 10 16 20 25 32 40 50 64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gg</span><span class="o">&lt;-</span><span class="n">ggplot</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gg</span><span class="o">+</span>
<span class="n">geom_line</span><span class="p">(</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">n_cpus</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="n">vector_with_time_medians</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../../_images/Computo_en_paralelo_usando_CPUS_en_SMC_370_0.png" src="../../_images/Computo_en_paralelo_usando_CPUS_en_SMC_370_0.png" />
</div>
</div>
<div class="tip admonition">
<p class="admonition-title">Ejercicio</p>
<p>Implementar la regla de Simpson compuesta con <em>Parallel</em> en una máquina de AWS con las mismas características que la que se presenta en esta nota, medir tiempo de ejecución y realizar gráfica de tiempo vs num cpus.</p>
</div>
</div>
</div>
<div class="section" id="referencias-de-interes">
<h2>Referencias de interés<a class="headerlink" href="#referencias-de-interes" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://stories.dask.org/en/latest/">Use cases with dask</a></p></li>
<li><p><a class="reference external" href="https://github.com/dask/dask-tutorial">dask-tutorial</a></p></li>
<li><p><a class="reference external" href="http://matthewrocklin.com/blog/">matthew-rocklin-blog</a>. Ver <a class="reference external" href="http://matthewrocklin.com/blog/work/2015/02/13/Towards-OOC-Slicing-and-Stacking">Towards-OutOfCore-ND-Arrays-Slicing-and-Stacking</a>. <a class="reference external" href="https://www.youtube.com/watch?v=ieW3G7ZzRZ0">Matthew Rocklin: Dask: out of core arrays with task scheduling</a></p></li>
</ul>
<p>En <em>dask</em> se hace referencia al uso de funciones <em>pure</em>. Ver: <a class="reference external" href="https://distributed.dask.org/en/latest/client.html#pure-functions-by-default">Pure Functions by Default</a> y <a class="reference external" href="https://toolz.readthedocs.io/en/latest/purity.html">Function Purity</a> para ejemplos de funciones <em>pure</em>.</p>
<p>En <a class="reference external" href="https://www.youtube.com/watch?v=EX_voquHdk0">Dask JupyterLab Extension</a> se muestra cómo instalar la extensión en jupyterlab para <em>Dask</em>.</p>
<ul class="simple">
<li><p><a class="reference external" href="http://www.sfu.ca/~sblay/R/snow.html">snow Simplified</a></p></li>
<li><p><a class="reference external" href="https://docs.microsoft.com/en-us/machine-learning-server/r/how-to-revoscaler-distributed-computing-foreach">Using foreach and iterators for manual parallel execution</a></p></li>
</ul>
<p>Paquete de <em>R</em>: <a class="reference external" href="https://www.rdocumentation.org/packages/future/versions/1.21.0">future</a></p>
<div class="tip admonition">
<p class="admonition-title">Ejercicios</p>
<p>1.Resuelve los ejercicios y preguntas de la nota.</p>
</div>
<p><strong>Preguntas de comprehensión:</strong></p>
<p>1)Menciona diferencias que surgen en un programa que se ejecuta en un sistema de memoria compartida contra los que se ejecutan en un sistema de memoria distribuida.</p>
<p>2)¿A qué se le llama no determinismo y da un ejemplo en el que esto surge en un sistema de memoria compartida?</p>
<p>3)¿Qué es una <em>critical section</em>? ¿qué es una <em>race condition</em>? ¿cómo se puede lidiar con las <em>critical sections</em>?</p>
<p>4)¿Cuál es la terminología para nombrar a las variables que pueden ser accesadas por todos los <em>threads</em> y para las variables que sólo pueden ser accesadas por un <em>thread</em>?</p>
<p><strong>Referencias:</strong></p>
<ol class="simple">
<li><p>P. Pacheco, An Introduction to Parallel Programming, Morgan Kaufmann, 2011.</p></li>
<li><p>M. Gorelick, I. Ozsvald, High Performance Python, O’Reilly Media, 2014.</p></li>
<li><p>N. Matloff, Parallel Computing for Data Science. With Examples in R, C++ and CUDA, 2014.</p></li>
<li><p>B. W. Kernighan, D. M. Ritchie, The C Programming Language, Prentice Hall Software Series, 1988</p></li>
<li><p><a class="reference external" href="https://github.com/palmoreck/programming-languages/tree/master/C/extensiones_a_C/openMP">C/extensiones_a_C/openMP</a></p></li>
</ol>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "palmoreck/dockerfiles-for-binder",
            ref: "jupyterlab_optimizacion_2",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./V.optimizacion_de_codigo/5.4"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        </div>
    </div>
    
    
    <div class='prev-next-bottom'>
        
    <a class='left-prev' id="prev-link" href="../5.3/Compilacion_a_C.html" title="previous page">5.3 Compilación a C</a>
    <a class='right-next' id="next-link" href="../5.5/Computo_en_paralelo_usando_GPUS_en_SMC.html" title="next page">5.5 Cómputo en paralelo usando GPUs en un sistema de memoria compartida (SMC)</a>

    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Erick Palacios Moreno<br/>
        
            &copy; Copyright 2020.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>

    
  <script src="../../_static/js/index.3da636dd464baa7582d2.js"></script>


    
  </body>
</html>